<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Rekod Bersepadu Pemandu v48</title>
    <!-- Library React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700;800&family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        :root {
            --win7-blue: #cbd9e9;
            --win7-glass: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(203,217,233,0.85) 100%);
        }

        body { 
            font-family: 'Segoe UI', 'Plus Jakarta Sans', sans-serif; 
            overflow-x: hidden; 
            transition: all 0.2s ease;
            margin: 0;
            padding: 0;
            line-height: 1.1;
        }

        .btn-3d {
            box-shadow: 0 1px 0 rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.1s ease;
            border: 1px solid rgba(0,0,0,0.2);
            padding: 2px 8px;
        }
        .btn-3d:active { transform: translateY(1px); box-shadow: none; }

        .theme-light { background: #E3E7ED; color: #020617; }
        .theme-light .glass-panel {
            background: var(--win7-glass);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.9);
        }
        .theme-light .btn-3d { background: linear-gradient(180deg, #ffffff 0%, #d1d9e6 100%); color: #0f172a; border: 1px solid #94a3b8; }

        .theme-dark { background: #0f172a; color: #f8fafc; }
        .theme-dark .glass-panel {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        }
        .theme-dark .btn-3d { 
            background: linear-gradient(180deg, #334155 0%, #1e293b 100%); 
            color: #fff; 
            border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 1px 0 rgba(0,0,0,0.5), 0 2px 4px rgba(0,0,0,0.3);
        }
        .theme-dark .btn-3d:active { box-shadow: none; transform: translateY(1px); }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 3px; }
        
        @media print {
            @page { size: landscape; margin: 5mm; }
            .print-hidden { display: none !important; }
            body { background: white !important; color: black !important; }
            .print-area { 
                position: absolute !important; 
                top: 0 !important; 
                left: 0 !important; 
                width: 100% !important; 
                z-index: 99999 !important; 
                background: white !important; 
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .report-matrix { width: 100%; border-collapse: collapse; table-layout: fixed; }
            .report-matrix th, .report-matrix td, .report-matrix tr, .print-holiday { 
                border: 1px solid black !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
            .report-matrix th { padding: 4px; font-size: 8px; background-color: #e2e8f0 !important; font-weight: bold; overflow: hidden; word-wrap: break-word; }
            .report-matrix td { padding: 4px; font-size: 8px; overflow: hidden; word-wrap: break-word; }
            .report-matrix tr { page-break-inside: avoid; }
            .print-holiday { background-color: #fef3c7 !important; }
            
            .glass-panel { background: white !important; border: none !important; box-shadow: none !important; backdrop-filter: none !important; }
            .fixed { position: relative !important; }
        }

        .sticky-col { position: sticky; left: 0; z-index: 40; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .u-icon { font-style: normal; font-weight: bold; }
        
        .stripe-row:nth-child(even) { background-color: rgba(0,0,0,0.015); }
        .theme-dark .stripe-row:nth-child(even) { background-color: rgba(255,255,255,0.01); }

        .holiday-row { background-color: rgba(251, 191, 36, 0.1) !important; }
        .theme-dark .holiday-row { background-color: #000000 !important; }

        .loader-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Responsive Calendar Cells */
        .calendar-cell { width: 140px; min-width: 140px; }
        @media (min-width: 640px) {
            .calendar-cell { width: 190px; min-width: 190px; }
        }
        .has-task-cell { background-color: rgba(59, 130, 246, 0.05) !important; }
        
        /* Hilangkan anak panah pada input nombor */
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="theme-light">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, Fragment } = React;

        const UIcon = ({ type, size = "text-[12px]", className = "" }) => {
            const icons = {
                lock: "üîí", user: "üë§", sun: "‚òÄÔ∏è", moon: "üåô", refresh: "üîÑ", check: "‚úÖ",
                logout: "üö™", add: "‚ûï", edit: "üìù", trash: "üóëÔ∏è", warn: "‚ö†Ô∏è",
                save: "üíæ", print: "üñ®Ô∏è", shield: "üõ°Ô∏è", pax: "üë•", notes: "üìë", 
                x: "‚úñÔ∏è", driver: "üë®‚Äç‚úàÔ∏è", settings: "‚öôÔ∏è", arrow: "‚¨ÖÔ∏è", arrowRight: "‚û°Ô∏è", filter: "üîç", clock: "üïí", calendar: "üìÖ", file: "üìÑ", up: "‚ñ≤", down: "‚ñº", list: "üìã", car: "üöó"
            };
            return <span className={`u-icon ${size} ${className}`}>{icons[type] || "‚Ä¢"}</span>;
        };

        const App = () => {
            const [view, setView] = useState('login'); 
            const [userRole, setUserRole] = useState(null); 
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [fontSize, setFontSize] = useState('sederhana');
            const [driverFilter, setDriverFilter] = useState('all');
            const [syncStatus, setSyncStatus] = useState('saved'); 
            const [isSaving, setIsSaving] = useState(false);
            const [user, setUser] = useState(null);
            
            const [passInput, setPassInput] = useState('');
            const [loginError, setLoginError] = useState('');

            // --- FIREBASE CONFIG ---
            const firebaseConfig = {
                apiKey: "AIzaSyDTJZUDG81Kjh0JyUi_K6_KG71SmiAXrOk",
                authDomain: "sistem-jadual-pemandu.firebaseapp.com",
                projectId: "sistem-jadual-pemandu",
                storageBucket: "sistem-jadual-pemandu.firebasestorage.app",
                messagingSenderId: "863854455337",
                appId: "1:863854455337:web:2e66be4bce87dfd08cca38",
                measurementId: "G-31LEV8F8VZ"
            };

            const appId = 'sistem-jadual-pemandu';
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            const [drivers, setDrivers] = useState([]);
            const [tasks, setTasks] = useState([]);

            const sortedDriversList = useMemo(() => {
                let list = [...drivers];
                list.sort((a, b) => (a.order ?? 999) - (b.order ?? 999) || a.name.localeCompare(b.name));
                if (driverFilter === 'tasks') list = list.filter(d => tasks.some(t => t.driverId === d.id));
                return list;
            }, [drivers, tasks, driverFilter]);

            // --- AUTH & SYNC ---
            useEffect(() => {
                auth.signInAnonymously().catch(err => console.error("Auth Fail"));
                const unsubscribe = auth.onAuthStateChanged((u) => setUser(u || null));
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const driversRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('drivers');
                const tasksRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks');

                const unsubDrivers = driversRef.onSnapshot(s => {
                    setDrivers(s.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const unsubTasks = tasksRef.onSnapshot(s => {
                    setTasks(s.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                return () => { unsubDrivers(); unsubTasks(); };
            }, [user]);

            // --- DB ACTIONS ---
            const writeTask = async (taskData) => {
                if (!user) return;
                setSyncStatus('syncing');
                const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks');
                const { id, ...payload } = taskData;
                try {
                    if (id) await ref.doc(id).set(payload, { merge: true });
                    else await ref.add(payload);
                    setSyncStatus('saved');
                } catch (err) { setSyncStatus('error'); }
            };

            const deleteTaskFromCloud = async (taskId) => {
                if (!user || !taskId) return;
                setSyncStatus('syncing');
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('tasks').doc(taskId).delete();
                    setSyncStatus('saved');
                    return true;
                } catch (err) { setSyncStatus('error'); return false; }
            };

            const addNewDriver = async (name) => {
                if (!user || !name) return;
                setSyncStatus('syncing');
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('drivers').add({ name, order: drivers.length + 1 });
                    setSyncStatus('saved');
                } catch (err) { setSyncStatus('error'); }
            };
            
            const updateDriverName = async (driverId, newName) => {
                if (!user || !driverId) return;
                setSyncStatus('syncing');
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('drivers').doc(driverId).update({ name: newName });
                    setSyncStatus('saved');
                } catch (err) { setSyncStatus('error'); }
            };

            const confirmDeleteDriver = async () => {
                if (!user || !driverToDelete) return;
                setSyncStatus('syncing');
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('drivers').doc(driverToDelete).delete();
                    setSyncStatus('saved');
                    setDriverToDelete(null);
                } catch (err) { setSyncStatus('error'); }
            };

            const swapDriverOrder = async (indexA, indexB) => {
                const list = [...sortedDriversList];
                if (indexB < 0 || indexB >= list.length) return;
                const driverA = list[indexA];
                const driverB = list[indexB];
                const batch = db.batch();
                const driversRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('drivers');
                batch.update(driversRef.doc(driverA.id), { order: indexB + 1 });
                batch.update(driversRef.doc(driverB.id), { order: indexA + 1 });
                try { await batch.commit(); setSyncStatus('saved'); } catch (err) { setSyncStatus('error'); }
            };

            // --- UI MODAL STATES ---
            const [selectedTask, setSelectedTask] = useState(null);
            const [showActionModal, setShowActionModal] = useState(false);
            const [showTaskFormModal, setShowTaskFormModal] = useState(false);
            const [isEditing, setIsEditing] = useState(false);
            const [showConflictModal, setShowConflictModal] = useState(false);
            const [conflictTask, setConflictTask] = useState(null);
            const [showDriverSummary, setShowDriverSummary] = useState(false);
            const [activeDriver, setActiveDriver] = useState(null);
            const [showDailySummary, setShowDailySummary] = useState(false);
            const [selectedDateForSummary, setSelectedDateForSummary] = useState(null);
            const [showDriverSwapList, setShowDriverSwapList] = useState(false);
            const [swapWarning, setSwapWarning] = useState('');
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [reportType, setReportType] = useState('mingguan');
            const [driverToDelete, setDriverToDelete] = useState(null);
            
            const initialFormState = {
                driverId: null, destination: '', matter: '',
                startDate: '', endDate: '', startTime: '08:00', returnTime: '12:00',
                paxCount: 0, paxNames: [], notes: '', leaveType: 'none', tripType: 'dua_hala'
            };
            const [taskForm, setTaskForm] = useState(initialFormState);

            const [newDriverInput, setNewDriverInput] = useState('');
            const [editingDriverId, setEditingDriverId] = useState(null);
            const [editingDriverName, setEditingDriverName] = useState('');

            // --- TIME PICKER STATE ---
            const [timePicker, setTimePicker] = useState({
                show: false,
                target: '', // 'startTime' | 'returnTime'
                mode: 'hours', // 'hours' | 'minutes'
                h: 8,
                m: 0,
                ampm: 'AM'
            });

            // --- HELPERS ---
            const getISODate = (d) => {
                if(!d) return '';
                const date = new Date(d);
                return date.toISOString().split('T')[0];
            };
            
            const getDayNameLong = (isoDate) => {
                if(!isoDate) return '-';
                return new Date(isoDate).toLocaleDateString('ms-MY', {weekday:'long'});
            };

            const formatDateShort = (isoDate) => {
                if(!isoDate) return '-';
                return new Date(isoDate).toLocaleDateString('ms-MY', {day:'numeric', month:'short'});
            };

            const format12h = (t) => {
                if(!t) return '-';
                try {
                    let [h, m] = t.split(':');
                    h = parseInt(h);
                    const ampm = h >= 12 ? 'PM' : 'AM';
                    h = h % 12 || 12;
                    return `${h.toString().padStart(2, '0')}:${m}${ampm}`;
                } catch(e) { return '-'; }
            };

            const addHoursToTime = (timeStr, hours) => {
                if (!timeStr) return '';
                let [h, m] = timeStr.split(':').map(Number);
                h = (h + hours) % 24;
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            };

            const getPaxNamesString = (names) => {
                if (Array.isArray(names)) return names.filter(n => n && n.trim() !== '').join(', ');
                return names || '';
            };

            const [currentWeekDate, setCurrentWeekDate] = useState(new Date());

            const weekDays = useMemo(() => {
                const start = new Date(currentWeekDate);
                const day = start.getDay();
                const diff = start.getDate() - day + (day === 0 ? -6 : 1);
                const mon = new Date(start.setDate(diff));
                return Array.from({ length: 7 }, (_, i) => {
                    const d = new Date(mon);
                    d.setDate(mon.getDate() + i);
                    return d;
                });
            }, [currentWeekDate]);

            const reportDays = useMemo(() => {
                if (reportType === 'mingguan') return weekDays;
                const year = currentWeekDate.getFullYear();
                const month = currentWeekDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                return Array.from({ length: daysInMonth }, (_, i) => new Date(year, month, i + 1));
            }, [reportType, currentWeekDate, weekDays]);

            // --- LOGIC: OVERLAP CHECK ---
            const checkDriverAvailability = (drvId, data) => {
                const startNew = `${data.startDate}T${data.startTime}`;
                const endNew = `${data.endDate}T${data.returnTime}`;
                return tasks.find(ex => {
                    if (ex.id === data.id) return false;
                    if (ex.driverId !== drvId) return false;
                    const startEx = `${ex.startDate}T${ex.startTime}`;
                    const endEx = `${ex.endDate}T${ex.returnTime}`;
                    return (startNew < endEx) && (endNew > startEx);
                });
            };

            // --- HANDLERS ---
            const handleAdminLogin = (e) => {
                e.preventDefault();
                if (passInput === 'admin') {
                    setUserRole('admin');
                    setView('dashboard');
                    setLoginError('');
                } else {
                    setLoginError('Kata Laluan Salah!');
                }
            };

            const handleSave = async () => {
                const conflict = checkDriverAvailability(taskForm.driverId, taskForm);
                if (conflict && userRole === 'admin') {
                    setConflictTask(conflict);
                    setShowConflictModal(true);
                    return;
                }
                setIsSaving(true);
                await writeTask(taskForm);
                setIsSaving(false);
                setShowTaskFormModal(false);
            };

            const handleFinalDelete = async () => {
                if (!taskForm.id) return;
                setIsSaving(true);
                const success = await deleteTaskFromCloud(taskForm.id);
                setIsSaving(false);
                if (success) {
                    setShowDeleteConfirm(false);
                    setShowTaskFormModal(false);
                }
            };

            const handleLeaveSelect = (type) => {
                let destination = taskForm.destination;
                let matter = taskForm.matter;
                let paxCount = taskForm.paxCount;
                let paxNames = taskForm.paxNames;
                let tripType = taskForm.tripType || 'dua_hala';
                if (type === 'rehat') { destination = 'CUTI REHAT'; matter = 'DALAM CUTI'; paxCount = 0; paxNames = []; tripType = ''; }
                else if (type === 'sakit') { destination = 'CUTI SAKIT'; matter = 'TIDAK SIHAT'; paxCount = 0; paxNames = []; tripType = ''; }
                else if (type === 'none') { destination = ''; matter = ''; tripType = 'dua_hala'; }
                setTaskForm({ ...taskForm, leaveType: type, destination, matter, paxCount, paxNames, tripType });
            };

            const handlePaxCountChange = (newCount) => {
                const count = Math.max(0, parseInt(newCount) || 0);
                let newNames = Array.isArray(taskForm.paxNames) ? [...taskForm.paxNames] : (taskForm.paxNames ? taskForm.paxNames.split(',').map(s=>s.trim()) : []);
                
                if (newNames.length > count) {
                    newNames = newNames.slice(0, count);
                } else {
                    while(newNames.length < count) newNames.push('');
                }
                setTaskForm({...taskForm, paxCount: count, paxNames: newNames});
            };

            // --- TIME PICKER LOGIC ---
            const openTimePicker = (targetField, currentValue) => {
                let h = 8, m = 0, ampm = 'AM';
                if (currentValue) {
                    let [ch, cm] = currentValue.split(':').map(Number);
                    ampm = ch >= 12 ? 'PM' : 'AM';
                    h = ch % 12 || 12;
                    m = cm;
                }
                setTimePicker({ show: true, target: targetField, mode: 'hours', h, m, ampm });
            };

            const confirmTimePicker = () => {
                let hours24 = timePicker.h;
                if (timePicker.ampm === 'PM' && hours24 < 12) hours24 += 12;
                if (timePicker.ampm === 'AM' && hours24 === 12) hours24 = 0;
                const newTime = `${hours24.toString().padStart(2, '0')}:${timePicker.m.toString().padStart(2, '0')}`;

                setTaskForm(prev => {
                    const updates = { [timePicker.target]: newTime };
                    // Auto calculate 4 hours after start time
                    if (timePicker.target === 'startTime') {
                        updates.returnTime = addHoursToTime(newTime, 4);
                    }
                    return { ...prev, ...updates };
                });
                setTimePicker(prev => ({ ...prev, show: false }));
            };

            const fs = { kecil: 'text-[9px]', sederhana: 'text-[10px]', besar: 'text-[11px]' }[fontSize];
            const themeClass = isDarkMode ? 'theme-dark' : 'theme-light';

            // DYNAMIC COLOR VARIABLES FOR DARK MODE CONTRAST
            const txtPrimary = isDarkMode ? 'text-slate-100' : 'text-slate-950';
            const txtSecondary = isDarkMode ? 'text-slate-400' : 'text-slate-500';
            const bgPanel = isDarkMode ? 'bg-slate-900 border-slate-700' : 'bg-white border-slate-200';
            const bgSubPanel = isDarkMode ? 'bg-slate-800 border-slate-600' : 'bg-slate-50 border-slate-200';
            const inputClass = `w-full p-2.5 sm:p-3 rounded-lg text-xs sm:text-sm border outline-none font-bold transition-all ${isDarkMode ? 'bg-slate-800 border-slate-600 text-slate-100 focus:border-amber-400 placeholder-slate-500' : 'bg-white border-slate-300 text-slate-950 focus:border-indigo-600 placeholder-slate-400'}`;

            const getTripTypeColor = (type) => {
                if (type === 'sehala') return isDarkMode ? 'bg-blue-900/50 text-blue-300 border-blue-700' : 'bg-blue-100 text-blue-700 border-blue-200';
                if (type === 'dua_hala') return isDarkMode ? 'bg-green-900/50 text-green-300 border-green-700' : 'bg-green-100 text-green-700 border-green-200';
                if (type === 'bermalam') return isDarkMode ? 'bg-purple-900/50 text-purple-300 border-purple-700' : 'bg-purple-100 text-purple-700 border-purple-200';
                return '';
            };

            const getTripTypeLabel = (type) => {
                if (type === 'sehala') return 'Sehala';
                if (type === 'dua_hala') return 'Dua Hala';
                if (type === 'bermalam') return 'Bermalam';
                return '';
            };

            // --- VIEW: LOGIN ---
            if (view === 'login') {
                return (
                    <div className={`min-h-screen flex items-center justify-center p-4 ${themeClass}`}>
                        <div className={`p-8 sm:p-10 rounded-3xl glass-panel w-full max-w-md border shadow-2xl ${isDarkMode ? 'text-slate-100' : 'text-slate-900'}`}>
                            <div className="mb-8 text-center flex flex-col items-center">
                                <div className={`w-20 h-20 rounded-2xl flex items-center justify-center mb-4 shadow-lg ${isDarkMode ? 'bg-slate-800 text-amber-400' : 'bg-slate-800 text-amber-400'}`}>
                                    <UIcon type="car" size="text-5xl" />
                                </div>
                                <h1 className="text-2xl sm:text-3xl font-black uppercase italic tracking-tighter leading-tight">Sistem Rekod Bersepadu Pemandu</h1>
                                <p className={`text-xs sm:text-sm font-bold uppercase mt-3 tracking-widest ${txtSecondary}`}>Logistik & Penjadualan</p>
                                <p className={`text-[10px] font-bold uppercase mt-1 ${isDarkMode ? 'text-slate-500' : 'text-slate-400'}`}>Versi 48</p>
                            </div>
                            
                            <div className="space-y-5 mt-8">
                                <button onClick={() => { setUserRole('driver'); setView('dashboard'); }} className={`w-full py-4 rounded-xl font-black uppercase text-xs flex items-center justify-center gap-2 active:scale-95 transition-all btn-3d ${isDarkMode ? 'bg-blue-600 text-white border-blue-700' : 'bg-blue-600 text-white border-blue-700'}`}>
                                    <UIcon type="calendar" size="text-sm"/> Lihat Jadual
                                </button>
                                
                                <div className={`flex items-center gap-3 py-2 ${isDarkMode ? 'opacity-40' : 'opacity-30'}`}>
                                    <div className="flex-grow h-px bg-current"></div>
                                    <span className="text-[10px] font-black uppercase">Admin Mod</span>
                                    <div className="flex-grow h-px bg-current"></div>
                                </div>
                                
                                <form onSubmit={handleAdminLogin} className="space-y-4">
                                    <input type="password" placeholder="Kunci Laluan Admin" className={inputClass + ' text-center text-sm sm:text-base'} value={passInput} onChange={e => setPassInput(e.target.value)} />
                                    {loginError && <p className="text-[10px] text-red-500 font-bold uppercase text-center">{loginError}</p>}
                                    <button type="submit" className={`w-full py-4 rounded-xl font-black uppercase text-xs active:scale-95 transition-all btn-3d ${isDarkMode ? 'bg-amber-500 text-slate-900 border-amber-600' : 'bg-slate-900 text-white border-slate-950'}`}>
                                        Sahkan Akses
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- VIEW: REPORTS (MATRIX PDF) ---
            if (view === 'reports') {
                const isMonthly = reportType === 'bulanan';
                const reportTitle = isMonthly 
                    ? `Laporan Bulanan: ${currentWeekDate.toLocaleDateString('ms-MY', {month: 'long', year: 'numeric'})}`
                    : `Laporan Mingguan: ${weekDays[0].toLocaleDateString('ms-MY', {day:'numeric', month:'short'})} - ${weekDays[6].toLocaleDateString('ms-MY', {day:'numeric', month:'short', year:'numeric'})}`;

                return (
                    <div className={`min-h-screen ${themeClass}`}>
                        <nav className={`h-12 border-b-2 flex items-center px-4 justify-between sticky top-0 z-50 print-hidden ${isDarkMode ? 'bg-slate-950 border-slate-800' : 'bg-slate-900 border-slate-950'}`}>
                            <div className="flex items-center gap-2">
                                <span className={`font-black text-xs sm:text-sm tracking-tighter uppercase ${isDarkMode ? 'text-amber-400' : 'text-amber-400'}`}>Sistem Rekod Bersepadu Pemandu <span className="text-white hidden sm:inline">- Logistik & Penjadualan</span></span>
                                <button onClick={() => setView('dashboard')} className={`text-[10px] font-black uppercase px-3 py-1 ml-2 rounded btn-3d ${isDarkMode ? 'bg-slate-800 text-slate-200 border-slate-700' : 'bg-white/10 text-white border-transparent'}`}><UIcon type="arrow" /> Jadual</button>
                            </div>
                        </nav>
                        
                        <main className="p-4 max-w-full mx-auto print-area bg-white text-black min-h-screen">
                            <div className="flex flex-col sm:flex-row justify-between items-center mb-6 print:mb-6 print-hidden">
                                <h1 className={`text-xl sm:text-2xl font-black uppercase italic ${txtPrimary}`}>Jana Laporan Matriks</h1>
                                <div className="flex gap-2 mt-3 sm:mt-0">
                                    <button onClick={() => setReportType('mingguan')} className={`px-4 py-2 text-xs font-black uppercase rounded btn-3d ${reportType === 'mingguan' ? 'bg-indigo-600 text-white' : (isDarkMode ? 'bg-slate-800 text-slate-300 border-slate-600' : 'bg-white text-slate-600 border-slate-300')}`}>Mingguan</button>
                                    <button onClick={() => setReportType('bulanan')} className={`px-4 py-2 text-xs font-black uppercase rounded btn-3d ${reportType === 'bulanan' ? 'bg-indigo-600 text-white' : (isDarkMode ? 'bg-slate-800 text-slate-300 border-slate-600' : 'bg-white text-slate-600 border-slate-300')}`}>Bulanan</button>
                                </div>
                            </div>

                            <div className={`text-center mb-6 ${isDarkMode ? 'text-slate-100 print:text-black' : 'text-slate-900'}`}>
                                <h2 className="text-2xl font-black uppercase tracking-tighter">REKOD TUGASAN KESELURUHAN</h2>
                                <div className="flex items-center justify-center gap-3 mt-2 print-hidden">
                                    <button onClick={() => { const d = new Date(currentWeekDate); isMonthly ? d.setMonth(d.getMonth() - 1) : d.setDate(d.getDate() - 7); setCurrentWeekDate(d); }} className={`px-3 py-1 rounded border active:scale-95 ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-300'}`}><UIcon type="arrow" size="text-sm" /></button>
                                    <span className="text-sm font-bold uppercase opacity-90 min-w-[200px]">{reportTitle}</span>
                                    <button onClick={() => { const d = new Date(currentWeekDate); isMonthly ? d.setMonth(d.getMonth() + 1) : d.setDate(d.getDate() + 7); setCurrentWeekDate(d); }} className={`px-3 py-1 rounded border active:scale-95 ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-300'}`}><UIcon type="arrowRight" size="text-sm" /></button>
                                    <button onClick={() => setCurrentWeekDate(new Date())} className={`ml-2 px-3 py-1 text-[10px] font-black uppercase rounded shadow-sm active:scale-95 ${isDarkMode ? 'bg-amber-500 text-slate-900' : 'bg-slate-900 text-white'}`}>Kini</button>
                                </div>
                                <p className="text-xs font-bold uppercase mt-2 opacity-70 hidden print:block">{reportTitle}</p>
                            </div>

                            <div className="w-full flex justify-end mb-4 print-hidden">
                                <button onClick={() => window.print()} className="px-5 py-3 bg-red-600 text-white rounded-lg font-black uppercase text-xs btn-3d flex items-center gap-2 active:scale-95">
                                    <UIcon type="file" size="text-sm" /> Jana Laporan PDF
                                </button>
                            </div>

                            <div className="overflow-x-auto w-full border border-black">
                                <table className="report-matrix bg-white text-black w-full table-fixed">
                                    <thead>
                                        <tr>
                                            <th className="w-20 sm:w-24 text-left p-2 text-[10px]">HARI / TARIKH</th>
                                            {sortedDriversList.map((d, dIdx) => (
                                                <th key={d.id} className={`text-center p-2 text-[10px] uppercase ${dIdx % 2 !== 0 ? 'bg-black/5' : ''}`}>{d.name}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {reportDays.map((date, rIdx) => {
                                            const dStr = getISODate(date);
                                            const isHoli = date.getDay() === 0 || date.getDay() === 6;
                                            const rowClass = isHoli ? 'print-holiday bg-amber-50' : (rIdx % 2 === 0 ? 'bg-slate-100/50' : 'bg-white');
                                            
                                            return (
                                                <tr key={dStr} className={rowClass}>
                                                    <td className="p-2 align-top border border-black">
                                                        <span className="font-black uppercase text-[10px]">{date.toLocaleDateString('ms-MY', {weekday:'short'})}</span><br/>
                                                        <span className="text-[9px]">{date.toLocaleDateString('ms-MY', {day:'numeric', month:'short'})}</span>
                                                    </td>
                                                    {sortedDriversList.map((d, dIdx) => {
                                                        const dayTasks = tasks.filter(t => t.driverId === d.id && t.startDate <= dStr && t.endDate >= dStr).sort((a, b) => a.startTime.localeCompare(b.startTime));
                                                        
                                                        let cellBg = '';
                                                        if (dayTasks.length > 0) {
                                                            cellBg = 'bg-blue-50/60';
                                                        } else if (dIdx % 2 !== 0 && !isHoli) {
                                                            cellBg = 'bg-black/[0.03]';
                                                        }

                                                        return (
                                                            <td key={d.id} className={`p-2 align-top border border-black text-[9px] leading-tight ${cellBg}`}>
                                                                {dayTasks.map(t => (
                                                                    <div key={t.id} className="mb-2 border-b border-gray-300 last:border-0 pb-1">
                                                                        <span className="font-black text-indigo-700">{format12h(t.startTime)}</span><br/>
                                                                        <span className="uppercase font-bold">{t.leaveType !== 'none' ? 'CUTI' : t.destination}</span>
                                                                        {t.leaveType === 'none' && t.tripType && <><br/><span className="text-[7px] font-black uppercase opacity-60">({getTripTypeLabel(t.tripType)})</span></>}
                                                                    </div>
                                                                ))}
                                                            </td>
                                                        )
                                                    })}
                                                </tr>
                                            )
                                        })}
                                    </tbody>
                                </table>
                            </div>
                            <div className={`mt-6 text-right text-[10px] uppercase font-bold opacity-50 hidden print:block text-black`}>
                                Laporan dijana pada: {new Date().toLocaleString('ms-MY')}
                            </div>
                        </main>
                    </div>
                );
            }

            // --- VIEW: SETTINGS (DRIVER MANAGEMENT) ---
            if (view === 'settings') {
                return (
                    <div className={`min-h-screen ${themeClass}`}>
                        <nav className={`h-12 border-b-2 flex items-center px-4 justify-between sticky top-0 z-50 print-hidden ${isDarkMode ? 'bg-slate-950 border-slate-800' : 'bg-slate-900 border-slate-950'}`}>
                            <div className="flex items-center gap-3">
                                <span className={`font-black text-xs sm:text-sm tracking-tighter uppercase ${isDarkMode ? 'text-amber-400' : 'text-amber-400'}`}>Sistem Rekod Bersepadu Pemandu <span className="text-white hidden sm:inline">- Logistik & Penjadualan</span></span>
                                <button onClick={() => setView('dashboard')} className={`text-xs font-black uppercase px-3 py-1.5 ml-2 rounded btn-3d ${isDarkMode ? 'bg-slate-800 text-slate-200 border-slate-700' : 'bg-white/10 text-white border-transparent'}`}><UIcon type="arrow" /> Jadual</button>
                            </div>
                        </nav>
                        <main className="p-4 max-w-3xl mx-auto">
                            <div className="flex justify-between items-center mb-6 px-2">
                                <h1 className={`text-2xl font-black uppercase italic tracking-tighter ${txtPrimary}`}>Tetapan Pemandu</h1>
                            </div>

                            <div className={`p-6 rounded-3xl border shadow-xl space-y-5 ${bgPanel}`}>
                                <div className="flex gap-3">
                                    <input type="text" className={inputClass} placeholder="Tambah Nama Pemandu Baru..." value={newDriverInput} onChange={e => setNewDriverInput(e.target.value)} />
                                    <button onClick={() => { addNewDriver(newDriverInput); setNewDriverInput(''); }} className={`px-6 py-3 rounded-xl font-black uppercase text-xs btn-3d active:scale-95 ${isDarkMode ? 'bg-amber-500 text-slate-900 border-amber-600' : 'bg-slate-900 text-white border-slate-950'}`}>Tambah</button>
                                </div>

                                <div className="space-y-2 max-h-[65vh] overflow-y-auto pr-2 custom-scrollbar">
                                    {sortedDriversList.map((d, idx) => (
                                        <div key={d.id} className={`p-3 px-4 rounded-xl border flex justify-between items-center shadow-sm ${bgSubPanel} ${txtPrimary}`}>
                                            {editingDriverId === d.id ? (
                                                <div className="flex gap-2 w-full">
                                                    <input type="text" className={inputClass + ' p-2 text-sm'} value={editingDriverName} onChange={e => setEditingDriverName(e.target.value)} />
                                                    <button onClick={() => { updateDriverName(d.id, editingDriverName); setEditingDriverId(null); }} className="px-4 py-2 bg-green-500 text-white rounded-lg font-black text-xs btn-3d"><UIcon type="check" size="text-sm" /></button>
                                                    <button onClick={() => setEditingDriverId(null)} className="px-4 py-2 bg-slate-500 text-white rounded-lg font-black text-xs btn-3d"><UIcon type="x" size="text-sm" /></button>
                                                </div>
                                            ) : (
                                                <Fragment>
                                                    <div className="flex items-center gap-3">
                                                        <div className="flex flex-col gap-1">
                                                            <button onClick={() => swapDriverOrder(idx, idx - 1)} className={`px-2 py-1 rounded disabled:opacity-20 transition-colors ${isDarkMode ? 'bg-slate-700 hover:bg-slate-600 text-amber-400' : 'bg-slate-200 hover:bg-slate-300 text-blue-600'}`} disabled={idx === 0}><UIcon type="up" size="text-[10px]" /></button>
                                                            <button onClick={() => swapDriverOrder(idx, idx + 1)} className={`px-2 py-1 rounded disabled:opacity-20 transition-colors ${isDarkMode ? 'bg-slate-700 hover:bg-slate-600 text-amber-400' : 'bg-slate-200 hover:bg-slate-300 text-blue-600'}`} disabled={idx === sortedDriversList.length - 1}><UIcon type="down" size="text-[10px]" /></button>
                                                        </div>
                                                        <span className="font-black uppercase text-sm ml-2 tracking-tight">{d.name}</span>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => { setEditingDriverId(d.id); setEditingDriverName(d.name); }} className={`p-2.5 rounded-lg border transition-colors ${isDarkMode ? 'bg-blue-900/40 text-blue-300 border-blue-800 hover:bg-blue-800/60' : 'text-blue-600 bg-blue-50 border-blue-100 hover:bg-blue-100'}`}><UIcon type="edit" size="text-sm" /></button>
                                                        <button onClick={() => setDriverToDelete(d.id)} className={`p-2.5 rounded-lg border transition-colors ${isDarkMode ? 'bg-red-900/40 text-red-300 border-red-800 hover:bg-red-800/60' : 'text-red-600 bg-red-50 border-red-100 hover:bg-red-100'}`}><UIcon type="trash" size="text-sm" /></button>
                                                    </div>
                                                </Fragment>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </main>

                        {/* DRIVER DELETE CONFIRM MODAL */}
                        {driverToDelete && (
                            <div className="fixed inset-0 z-[300] bg-black/90 flex items-center justify-center p-4 text-white text-center">
                                <div className="bg-slate-900 border-2 border-red-600 p-8 rounded-3xl max-w-sm shadow-2xl">
                                    <UIcon type="warn" size="text-5xl" className="text-red-500 mb-4 block mx-auto animate-pulse" />
                                    <h3 className="text-xl font-black uppercase mb-2">Padam Pemandu?</h3>
                                    <p className="text-xs opacity-70 mb-6 font-bold">Maklumat pemandu ini akan dipadamkan secara kekal.</p>
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={confirmDeleteDriver} className="py-3 bg-red-600 text-white rounded-xl font-black uppercase text-xs btn-3d">Ya, Padam</button>
                                        <button onClick={() => setDriverToDelete(null)} className="py-3 bg-slate-700 text-white rounded-xl font-black uppercase text-xs btn-3d border border-slate-600">Batal</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // --- VIEW: MAIN DASHBOARD ---
            return (
                <div className={`min-h-screen ${themeClass}`}>
                    <nav className={`h-12 border-b-2 flex items-center px-4 justify-between sticky top-0 z-50 print-hidden ${isDarkMode ? 'bg-slate-950 border-slate-800' : 'bg-slate-900 border-slate-950 text-white'}`}>
                        <div className="flex items-center gap-2 font-black">
                            <span className="text-xs sm:text-sm uppercase tracking-tighter italic text-amber-400">Sistem Rekod Bersepadu Pemandu <span className="text-white hidden sm:inline">- Logistik & Penjadualan</span></span>
                            <span className={`px-2 py-0.5 ml-2 rounded text-[9px] uppercase ${isDarkMode ? 'bg-slate-800 text-amber-400' : 'bg-white/10 text-amber-200'}`}>{userRole || 'TETAMU'}</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className={`hidden sm:flex items-center gap-1.5 px-3 py-1 rounded-full border ${isDarkMode ? 'bg-slate-900 border-slate-700' : 'bg-black/40 border-white/5 text-white'}`}>
                                <span className={`w-2 h-2 rounded-full ${syncStatus === 'syncing' ? 'bg-amber-500 loader-spin' : 'bg-green-500'}`}></span>
                                <span className="text-[9px] font-black uppercase text-slate-400">{syncStatus === 'syncing' ? 'Sync' : 'Live'}</span>
                            </div>
                            
                            <span className={`hidden md:block font-black text-xs uppercase px-4 py-1.5 rounded-lg border ml-2 mr-2 ${isDarkMode ? 'bg-slate-900 border-slate-700 text-slate-100' : 'bg-slate-800 border-slate-700 text-white'}`}>
                                {new Date().toLocaleDateString('ms-MY', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                            </span>
                            
                            {userRole && (
                                <button onClick={() => setView('reports')} className={`p-2 flex items-center justify-center rounded-lg btn-3d ${isDarkMode ? 'bg-slate-800 text-blue-400 border-slate-700' : 'glass-panel text-blue-300'}`} title="Laporan Matrix"><UIcon type="list" size="text-sm" /></button>
                            )}
                            
                            {userRole === 'admin' && (
                                <button onClick={() => setView('settings')} className={`p-2 flex items-center justify-center rounded-lg btn-3d ${isDarkMode ? 'bg-slate-800 text-amber-400 border-slate-700' : 'glass-panel text-amber-400'}`} title="Urus Pemandu"><UIcon type="settings" size="text-sm" /></button>
                            )}
                            <button onClick={() => setIsDarkMode(!isDarkMode)} className={`p-2 flex items-center justify-center rounded-lg btn-3d transition-all ${isDarkMode ? 'bg-slate-800 text-amber-400 border-slate-700' : 'glass-panel text-white'}`} title="Tema"><UIcon type={isDarkMode ? "sun" : "moon"} size="text-sm" /></button>
                            <button onClick={() => { setView('login'); setUserRole(null); setPassInput(''); }} className={`p-2 flex items-center justify-center rounded-lg btn-3d transition-all ${isDarkMode ? 'bg-slate-800 text-red-400 border-slate-700' : 'bg-red-900/30 text-red-400'}`} title="Log Keluar"><UIcon type="logout" size="text-sm" /></button>
                        </div>
                    </nav>

                    <main className="p-2 sm:p-3 max-w-full print-hidden">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3 px-1 gap-3">
                            <div className="flex flex-col">
                                <h1 className={`text-xl sm:text-2xl font-black italic uppercase ${txtPrimary}`}>Jadual Penyelarasan</h1>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => { const d = new Date(currentWeekDate); d.setDate(d.getDate() - 7); setCurrentWeekDate(d); }} className={`px-3 py-1.5 rounded-lg border shadow-sm active:scale-95 ${isDarkMode ? 'bg-slate-800 border-slate-600 text-slate-200' : 'bg-white border-slate-300 text-slate-800'}`}><UIcon type="arrow" size="text-sm" /></button>
                                <div className={`flex flex-col text-center px-2 min-w-[140px] sm:min-w-[180px] ${txtPrimary}`}>
                                    <span className="text-[9px] sm:text-[10px] font-black uppercase opacity-60">Minggu Semasa</span>
                                    <span className="text-[10px] sm:text-xs font-black uppercase tracking-widest">
                                        {weekDays[0].toLocaleDateString('ms-MY', {day:'numeric', month:'short'})} ‚Äî {weekDays[6].toLocaleDateString('ms-MY', {day:'numeric', month:'short', year:'numeric'})}
                                    </span>
                                </div>
                                <button onClick={() => { const d = new Date(currentWeekDate); d.setDate(d.getDate() + 7); setCurrentWeekDate(d); }} className={`px-3 py-1.5 rounded-lg border shadow-sm active:scale-95 ${isDarkMode ? 'bg-slate-800 border-slate-600 text-slate-200' : 'bg-white border-slate-300 text-slate-800'}`}><UIcon type="arrowRight" size="text-sm" /></button>
                                <button onClick={() => setCurrentWeekDate(new Date())} className={`ml-2 px-3 py-1.5 text-xs font-black uppercase rounded-lg shadow-sm active:scale-95 btn-3d ${isDarkMode ? 'bg-amber-500 text-slate-900 border-amber-600' : 'bg-slate-900 text-white border-slate-950'}`}>Kini</button>
                            </div>
                        </div>

                        <div className={`overflow-hidden rounded-xl border-2 shadow-xl ${isDarkMode ? 'border-slate-800 bg-slate-900' : 'border-slate-300 bg-white'}`}>
                            <div className="overflow-x-auto custom-scrollbar">
                                <table className="w-full border-collapse table-fixed min-w-[2000px] sm:min-w-[3000px]">
                                    <thead>
                                        <tr className={`${isDarkMode ? 'bg-slate-950 text-amber-400' : 'bg-slate-800 text-white'} text-[10px] sm:text-xs font-black uppercase`}>
                                            <th className={`p-2 sm:p-3 text-left sticky-col border-r shadow-xl ${isDarkMode ? 'bg-slate-950 border-slate-800 w-32 sm:w-48' : 'bg-slate-800 border-white/10 w-32 sm:w-48'}`}>HARI / TARIKH</th>
                                            {sortedDriversList.map((d, dIdx) => (
                                                <th key={d.id} className={`p-2 border-l text-center calendar-cell ${isDarkMode ? 'border-slate-800 text-white' : 'border-white/5 text-white'} ${dIdx % 2 !== 0 ? 'bg-black/10' : ''}`}>
                                                    <button onClick={() => { setActiveDriver(d); setShowDriverSummary(true); }} className={`truncate w-full uppercase font-black text-[10px] sm:text-xs transition-colors ${isDarkMode ? 'hover:text-white' : 'hover:text-amber-400'}`}>{d.name}</button>
                                                </th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody className={`divide-y ${isDarkMode ? 'divide-slate-800' : 'divide-slate-200'}`}>
                                        {weekDays.map((date, rIdx) => {
                                            const isHoli = date.getDay() === 0 || date.getDay() === 6;
                                            const dStr = getISODate(date);
                                            
                                            // Zebra striping for rows
                                            const rowClass = isHoli 
                                                ? (isDarkMode ? 'bg-black' : 'bg-amber-100/50') 
                                                : (rIdx % 2 === 0 ? (isDarkMode ? 'bg-slate-800/20' : 'bg-slate-50/50') : (isDarkMode ? 'bg-transparent' : 'bg-white'));
                                            
                                            const stickyCellClass = isHoli 
                                                ? (isDarkMode ? 'bg-black text-amber-500 border-slate-800 shadow-xl' : 'bg-amber-100 text-amber-950 border-amber-200 shadow-xl')
                                                : (isDarkMode ? 'bg-slate-900 text-amber-200 border-slate-800 shadow-lg' : 'bg-blue-50 border-slate-300 text-slate-950 shadow-lg');

                                            return (
                                                <tr key={date.toString()} className={rowClass}>
                                                    <td onClick={() => { setSelectedDateForSummary(date); setShowDailySummary(true); }} className={`p-2 sm:p-4 sticky-col z-30 border-r cursor-pointer transition-all hover:brightness-110 ${stickyCellClass}`}>
                                                        <div className="font-black text-xs sm:text-sm uppercase leading-none">{date.toLocaleDateString('ms-MY', {weekday:'long'})}</div>
                                                        <div className="text-[10px] sm:text-xs font-bold opacity-70 mt-1 uppercase">{date.toLocaleDateString('ms-MY', {day:'numeric', month:'long'})}</div>
                                                    </td>
                                                    {sortedDriversList.map((d, cIdx) => {
                                                        const dayTasks = tasks.filter(t => t.driverId === d.id && t.startDate <= dStr && t.endDate >= dStr).sort((a, b) => a.startTime.localeCompare(b.startTime));
                                                        const hasLeave = dayTasks.some(t => t.leaveType !== 'none');
                                                        
                                                        // Zebra striping for columns
                                                        let cellBg = '';
                                                        if (dayTasks.length > 0) {
                                                            cellBg = isDarkMode ? 'bg-slate-800/40' : 'bg-blue-50/40';
                                                        } else if (cIdx % 2 !== 0 && !isHoli) {
                                                            cellBg = isDarkMode ? 'bg-white/[0.02]' : 'bg-black/[0.02]';
                                                        }

                                                        return (
                                                            <td key={d.id} className={`p-1 border-l align-top h-28 sm:h-32 calendar-cell ${cellBg} ${isDarkMode ? 'border-slate-800' : 'border-slate-200'}`}>
                                                                <div className="flex flex-col gap-1 h-full">
                                                                    {dayTasks.map(t => {
                                                                        const tCardClass = t.leaveType === 'rehat' 
                                                                            ? (isDarkMode ? 'bg-yellow-900/60 border-yellow-700 text-yellow-200' : 'bg-yellow-400 border-yellow-500 text-black')
                                                                            : t.leaveType === 'sakit' 
                                                                            ? (isDarkMode ? 'bg-red-900/60 border-red-700 text-red-200' : 'bg-red-600 border-red-700 text-white')
                                                                            : (isDarkMode ? 'bg-slate-800 border-slate-600 text-slate-200' : 'bg-white border-slate-300 text-slate-950');
                                                                            
                                                                        const timeClass = t.leaveType === 'none' ? (isDarkMode ? 'text-blue-400' : 'text-indigo-700') : '';

                                                                        return (
                                                                            <div key={t.id} onClick={() => { setSelectedTask(t); setShowActionModal(true); }} className={`task-card p-1.5 sm:p-2 rounded-lg border-2 shadow-sm cursor-pointer active:scale-95 transition-all flex flex-col gap-0.5 ${tCardClass}`}>
                                                                                <div className="flex justify-between items-center leading-none mb-1">
                                                                                    <span className={`font-black text-[10px] sm:text-xs ${timeClass}`}>{format12h(t.startTime)}</span>
                                                                                    <div className="flex items-center gap-1">
                                                                                        {t.paxCount > 0 && t.leaveType === 'none' && (
                                                                                            <span className="text-[8px] sm:text-[10px] font-black opacity-60 flex items-center gap-0.5"><UIcon type="pax" size="text-[8px] sm:text-[10px]"/>{t.paxCount}</span>
                                                                                        )}
                                                                                        {t.leaveType !== 'none' && <span className="text-[8px] sm:text-[9px] font-black uppercase tracking-tighter bg-black/20 px-1 rounded">Cuti</span>}
                                                                                    </div>
                                                                                </div>
                                                                                <div className={`text-[10px] sm:text-xs font-bold uppercase line-clamp-2 leading-tight`}>{t.destination || '-'}</div>
                                                                                
                                                                                <div className="flex items-center justify-between mt-0.5">
                                                                                    {t.paxNames && t.leaveType === 'none' && <div className="text-[8px] sm:text-[9px] font-bold uppercase opacity-70 truncate max-w-[60%]">{getPaxNamesString(t.paxNames)}</div>}
                                                                                    {t.leaveType === 'none' && t.tripType && (
                                                                                        <span className={`text-[6px] sm:text-[7px] font-black uppercase px-1 py-0.5 rounded border ${getTripTypeColor(t.tripType)}`}>
                                                                                            {getTripTypeLabel(t.tripType)}
                                                                                        </span>
                                                                                    )}
                                                                                </div>
                                                                            </div>
                                                                        )
                                                                    })}
                                                                    {userRole === 'admin' && !hasLeave && (
                                                                        <button onClick={() => { setTaskForm({ ...initialFormState, driverId: d.id, startDate: dStr, endDate: dStr, startTime: '08:00', returnTime: '12:00', paxNames: [] }); setIsEditing(false); setShowTaskFormModal(true); }} className={`mt-auto w-full py-1.5 border-2 border-dashed rounded-lg opacity-40 hover:opacity-100 transition-all ${isDarkMode ? 'border-amber-500 text-amber-500 hover:bg-slate-800' : 'border-indigo-400 text-indigo-600 hover:bg-white'}`}><UIcon type="add" size="text-[10px] sm:text-xs" /></button>
                                                                    )}
                                                                </div>
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>

                    {/* MODAL: RINGKASAN TUGAS (VIEW ONLY) */}
                    {showActionModal && selectedTask && (
                        <div className="fixed inset-0 z-[150] bg-black/80 backdrop-blur-sm flex items-center justify-center p-3">
                            <div className={`w-full max-w-sm p-6 rounded-3xl border shadow-2xl ${bgPanel} ${txtPrimary}`}>
                                <h2 className={`text-xl font-black uppercase italic mb-4 ${isDarkMode ? 'text-amber-400' : 'text-indigo-600'}`}>Ringkasan Tugas</h2>
                                <div className="space-y-3 mb-6 text-xs font-bold">
                                    <div className={`grid ${selectedTask.leaveType === 'none' && selectedTask.tripType === 'sehala' ? 'grid-cols-1' : 'grid-cols-2'} gap-3 p-3 rounded-xl border ${isDarkMode ? 'bg-slate-800 border-slate-600' : 'bg-blue-50 border-blue-100'}`}>
                                        <div><p className={`text-[9px] uppercase font-black ${isDarkMode ? 'opacity-70 text-amber-400' : 'opacity-50'}`}>{selectedTask.leaveType === 'none' && selectedTask.tripType === 'sehala' ? 'Tarikh & Masa Bertolak' : 'Mula'}</p><p className="font-black">{getDayNameLong(selectedTask.startDate)}</p><p className={`font-black ${isDarkMode ? 'text-blue-400' : 'text-blue-700'}`}>{format12h(selectedTask.startTime)}</p></div>
                                        {!(selectedTask.leaveType === 'none' && selectedTask.tripType === 'sehala') && (
                                            <div><p className={`text-[9px] uppercase font-black ${isDarkMode ? 'opacity-70 text-amber-400' : 'opacity-50'}`}>Tamat</p><p className="font-black">{getDayNameLong(selectedTask.endDate)}</p><p className={`font-black ${isDarkMode ? 'text-blue-400' : 'text-blue-700'}`}>{format12h(selectedTask.returnTime)}</p></div>
                                        )}
                                    </div>
                                    <div className={`p-3 rounded-xl border ${selectedTask.leaveType === 'rehat' ? (isDarkMode ? 'bg-yellow-900/40 border-yellow-700 text-yellow-200' : 'bg-yellow-100 border-yellow-300 text-yellow-900') : selectedTask.leaveType === 'sakit' ? (isDarkMode ? 'bg-red-900/40 border-red-700 text-red-200' : 'bg-red-100 border-red-300 text-red-900') : bgSubPanel}`}>
                                        <p className="font-black text-sm uppercase leading-tight mb-1">
                                            {selectedTask.leaveType !== 'none' ? (selectedTask.leaveType === 'rehat' ? 'CUTI REHAT' : 'CUTI SAKIT') : (selectedTask.destination || '(Tiada)')}
                                        </p>
                                        {selectedTask.leaveType === 'none' && selectedTask.tripType && (
                                            <span className={`inline-block mb-1 text-[9px] px-1.5 py-0.5 rounded font-black uppercase border ${getTripTypeColor(selectedTask.tripType)}`}>
                                                {getTripTypeLabel(selectedTask.tripType)}
                                            </span>
                                        )}
                                        <p className={`opacity-80 font-bold text-[10px] ${selectedTask.leaveType !== 'none' ? 'uppercase' : ''}`}>Urusan: {selectedTask.matter || '-'}</p>
                                        {selectedTask.leaveType === 'none' && <p className="opacity-80 mt-1 italic font-bold text-[10px]">Pax: {selectedTask.paxCount} ({getPaxNamesString(selectedTask.paxNames) || '-'})</p>}
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => { 
                                        setTaskForm({ 
                                            ...selectedTask,
                                            paxNames: Array.isArray(selectedTask.paxNames) ? selectedTask.paxNames : (selectedTask.paxNames ? selectedTask.paxNames.split(',').map(s=>s.trim()) : [])
                                        }); 
                                        setIsEditing(true); setShowActionModal(false); setShowTaskFormModal(true); 
                                    }} className={`py-4 rounded-xl font-black uppercase text-xs btn-3d active:scale-95 text-white ${isDarkMode ? 'bg-blue-600 border-blue-700' : 'bg-blue-600 border-blue-700'}`}>
                                        {userRole === 'admin' ? 'Pinda' : 'Catatan'}
                                    </button>
                                    <button onClick={() => setShowActionModal(false)} className={`py-4 rounded-xl font-black uppercase text-xs btn-3d active:scale-95 ${isDarkMode ? 'bg-slate-700 text-white border-slate-600' : 'bg-slate-400 text-white border-slate-500'}`}>Tutup</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL: CUSTOM ANALOG TIME PICKER */}
                    {timePicker.show && (
                        <div className="fixed inset-0 z-[400] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className={`w-full max-w-xs p-6 rounded-[2.5rem] border shadow-2xl ${bgPanel} ${txtPrimary}`}>
                                <h3 className="text-center font-black uppercase mb-4 text-xs opacity-70">
                                    Pilih {timePicker.target === 'startTime' ? 'Waktu Pergi' : 'Waktu Pulang'}
                                </h3>
                                
                                {/* Digital Display Header */}
                                <div className="flex justify-center items-baseline gap-2 mb-6 text-5xl font-black tracking-tighter">
                                    <button onClick={() => setTimePicker({...timePicker, mode: 'hours'})} className={`focus:outline-none transition-colors ${timePicker.mode === 'hours' ? 'text-amber-500' : 'opacity-40 hover:opacity-80'}`}>
                                        {timePicker.h.toString().padStart(2, '0')}
                                    </button>
                                    <span className="opacity-40 pb-1">:</span>
                                    <button onClick={() => setTimePicker({...timePicker, mode: 'minutes'})} className={`focus:outline-none transition-colors ${timePicker.mode === 'minutes' ? 'text-amber-500' : 'opacity-40 hover:opacity-80'}`}>
                                        {timePicker.m.toString().padStart(2, '0')}
                                    </button>
                                    <div className="flex flex-col text-[10px] ml-2 space-y-1">
                                        <button onClick={() => setTimePicker({...timePicker, ampm: 'AM'})} className={`px-2 py-1 rounded font-black ${timePicker.ampm === 'AM' ? 'bg-amber-500 text-black' : 'bg-slate-800 text-white'}`}>AM</button>
                                        <button onClick={() => setTimePicker({...timePicker, ampm: 'PM'})} className={`px-2 py-1 rounded font-black ${timePicker.ampm === 'PM' ? 'bg-amber-500 text-black' : 'bg-slate-800 text-white'}`}>PM</button>
                                    </div>
                                </div>

                                {/* Analog Face */}
                                <div className={`relative w-56 h-56 mx-auto rounded-full border-4 mb-8 ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-100 border-slate-200'}`}>
                                    {/* Center Dot */}
                                    <div className="absolute top-1/2 left-1/2 w-2 h-2 bg-amber-500 rounded-full transform -translate-x-1/2 -translate-y-1/2"></div>
                                    
                                    {(timePicker.mode === 'hours' ? [12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11] : [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55]).map((val, i) => {
                                        const angle = (i * 30) - 90;
                                        const rad = angle * (Math.PI / 180);
                                        const x = 50 + 38 * Math.cos(rad);
                                        const y = 50 + 38 * Math.sin(rad);
                                        const isSelected = timePicker.mode === 'hours' ? timePicker.h === val : timePicker.m === val;
                                        
                                        return (
                                            <button
                                                key={val}
                                                onClick={() => {
                                                    if (timePicker.mode === 'hours') {
                                                        setTimePicker({...timePicker, h: val, mode: 'minutes'});
                                                    } else {
                                                        setTimePicker({...timePicker, m: val});
                                                    }
                                                }}
                                                className={`absolute w-9 h-9 rounded-full flex items-center justify-center text-sm font-black transition-all transform -translate-x-1/2 -translate-y-1/2 ${isSelected ? 'bg-amber-500 text-black scale-110 shadow-lg' : (isDarkMode ? 'text-slate-300 hover:bg-slate-700' : 'text-slate-700 hover:bg-slate-300')}`}
                                                style={{ left: `${x}%`, top: `${y}%` }}
                                            >
                                                {val.toString().padStart(2, '0')}
                                            </button>
                                        );
                                    })}
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={confirmTimePicker} className="py-4 bg-blue-600 text-white rounded-xl font-black uppercase text-xs btn-3d active:scale-95 border-blue-700">Tetapkan</button>
                                    <button onClick={() => setTimePicker({...timePicker, show: false})} className={`py-4 rounded-xl font-black uppercase text-xs btn-3d active:scale-95 ${isDarkMode ? 'bg-slate-700 text-white border-slate-600' : 'bg-slate-300 text-slate-900 border-slate-400'}`}>Batal</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL: TASK FORM */}
                    {showTaskFormModal && (
                        <div className="fixed inset-0 z-[110] bg-black/80 backdrop-blur-sm flex items-center justify-center p-3">
                             <div className={`w-full max-w-sm p-6 rounded-3xl border shadow-2xl overflow-y-auto max-h-[95vh] ${bgPanel} ${txtPrimary}`}>
                                <div className={`flex justify-between items-center mb-4 border-b pb-3 ${isDarkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                                    <h2 className={`text-xl font-black uppercase italic tracking-tighter ${isDarkMode ? 'text-amber-400' : 'text-slate-950'}`}>{isEditing ? 'Pinda Data' : 'Daftar Tugas'}</h2>
                                    <div className="flex items-center gap-2">
                                        {isEditing && userRole === 'admin' && (
                                            <button onClick={() => setShowDeleteConfirm(true)} className="p-2 bg-red-100 text-red-600 hover:bg-red-600 hover:text-white rounded-lg transition-colors border border-red-200" title="Padam Rekod">
                                                <UIcon type="trash" size="text-sm" />
                                            </button>
                                        )}
                                        <button onClick={() => setShowTaskFormModal(false)} className={`p-2 rounded-lg transition-colors ${isDarkMode ? 'bg-slate-800 hover:bg-slate-700 text-slate-300' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'}`}>
                                            <UIcon type="x" size="text-sm" />
                                        </button>
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    <div className="relative">
                                        <div onClick={() => setShowDriverSwapList(!showDriverSwapList)} className={`p-4 rounded-xl border flex justify-between items-center cursor-pointer shadow btn-3d ${isDarkMode ? 'bg-slate-800 border-slate-600 text-white' : 'bg-slate-900 border-slate-950 text-white'}`}>
                                            <div><p className={`text-[9px] uppercase font-black mb-1 ${isDarkMode ? 'text-amber-400' : 'text-amber-400'}`}>Tukar Pemandu</p><p className="font-black uppercase text-sm">{drivers.find(d => d.id === taskForm.driverId)?.name}</p></div>
                                            <UIcon type="refresh" size="text-base" className="text-amber-400" />
                                        </div>
                                        {showDriverSwapList && (
                                            <div className={`absolute top-full left-0 w-full mt-1 border rounded-xl shadow-xl z-50 p-2 max-h-48 overflow-y-auto grid grid-cols-1 gap-1 ${isDarkMode ? 'bg-slate-800 border-slate-600' : 'bg-white border-slate-200'}`}>
                                                {sortedDriversList.map(d => {
                                                    const isBusy = checkDriverAvailability(d.id, taskForm);
                                                    return (
                                                        <button key={d.id} onClick={() => {
                                                            if (isBusy) { setSwapWarning(`Amaran: ${d.name} Sibuk!`); setTimeout(() => setSwapWarning(''), 2000); }
                                                            else { setTaskForm({...taskForm, driverId: d.id}); setShowDriverSwapList(false); }
                                                        }} className={`p-2.5 text-left rounded-lg text-[10px] font-black uppercase flex justify-between ${taskForm.driverId === d.id ? 'bg-blue-600 text-white' : (isDarkMode ? 'hover:bg-slate-700 text-slate-200' : 'hover:bg-slate-100 text-slate-900')} ${isBusy ? 'opacity-30' : ''}`}>
                                                            <span>{d.name}</span>
                                                            {isBusy && <span className="text-[8px] bg-red-100 text-red-600 px-2 py-0.5 rounded">Sibuk</span>}
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                    {swapWarning && <div className="p-2 bg-red-600 text-white text-[10px] font-black uppercase text-center rounded-lg">{swapWarning}</div>}

                                    <div className={`p-3 rounded-xl border flex flex-col gap-3 ${bgSubPanel} ${userRole !== 'admin' ? 'opacity-40 pointer-events-none' : ''}`}>
                                        <div className="flex items-center justify-around w-full">
                                            <label className={`flex items-center gap-2 text-[10px] font-black uppercase cursor-pointer ${txtPrimary}`}><input type="radio" name="ltype" checked={taskForm.leaveType === 'none'} onChange={() => handleLeaveSelect('none')} className="w-4 h-4" /> Tugas</label>
                                            <label className="flex items-center gap-2 text-[10px] font-black uppercase cursor-pointer text-amber-500"><input type="radio" name="ltype" checked={taskForm.leaveType === 'rehat'} onChange={() => handleLeaveSelect('rehat')} className="w-4 h-4" /> Rehat</label>
                                            <label className="flex items-center gap-2 text-[10px] font-black uppercase cursor-pointer text-red-500"><input type="radio" name="ltype" checked={taskForm.leaveType === 'sakit'} onChange={() => handleLeaveSelect('sakit')} className="w-4 h-4" /> Sakit</label>
                                        </div>
                                        
                                        {/* Pilihan Jenis Perjalanan */}
                                        {taskForm.leaveType === 'none' && (
                                            <div className={`pt-3 border-t flex flex-wrap items-center justify-around gap-2 ${isDarkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                                                <span className={`text-[8px] font-black uppercase opacity-70 w-full text-center ${txtPrimary}`}>Jenis Perjalanan</span>
                                                <label className={`flex items-center gap-1.5 text-[9px] font-black uppercase cursor-pointer ${taskForm.tripType === 'sehala' ? 'text-blue-500' : txtPrimary}`}>
                                                    <input type="radio" name="tType" checked={taskForm.tripType === 'sehala'} onChange={() => setTaskForm(prev => ({...prev, tripType: 'sehala', endDate: prev.startDate}))} className="w-3 h-3" /> Sehala
                                                </label>
                                                <label className={`flex items-center gap-1.5 text-[9px] font-black uppercase cursor-pointer ${taskForm.tripType === 'dua_hala' ? 'text-green-500' : txtPrimary}`}>
                                                    <input type="radio" name="tType" checked={taskForm.tripType === 'dua_hala'} onChange={() => setTaskForm({...taskForm, tripType: 'dua_hala'})} className="w-3 h-3" /> Dua Hala
                                                </label>
                                                <label className={`flex items-center gap-1.5 text-[9px] font-black uppercase cursor-pointer ${taskForm.tripType === 'bermalam' ? 'text-purple-500' : txtPrimary}`}>
                                                    <input type="radio" name="tType" checked={taskForm.tripType === 'bermalam'} onChange={() => setTaskForm({...taskForm, tripType: 'bermalam'})} className="w-3 h-3" /> Bermalam
                                                </label>
                                            </div>
                                        )}
                                    </div>

                                    <div className={`space-y-3 ${userRole !== 'admin' ? 'opacity-40 pointer-events-none' : ''}`}>
                                        <div className={`grid ${taskForm.leaveType === 'none' && taskForm.tripType === 'sehala' ? 'grid-cols-1' : 'grid-cols-2'} gap-3 p-3 rounded-xl border ${isDarkMode ? 'bg-slate-800/50 border-slate-700' : 'bg-blue-50/30 border-slate-200'}`}>
                                            <div className="space-y-1">
                                                <label className={`text-[9px] font-black uppercase opacity-70 ml-1 ${txtPrimary}`}>{taskForm.leaveType === 'none' && taskForm.tripType === 'sehala' ? 'Tarikh & Masa Pergi' : 'Pergi'}</label>
                                                <input type="date" className={inputClass} value={taskForm.startDate || ''} onChange={e => setTaskForm(prev => ({...prev, startDate: e.target.value, ...(prev.tripType === 'sehala' ? {endDate: e.target.value} : {})}))} />
                                                <button type="button" onClick={() => openTimePicker('startTime', taskForm.startTime)} className={`${inputClass} mt-1 w-full text-left flex items-center justify-between`}>
                                                    <span>{format12h(taskForm.startTime)}</span><UIcon type="clock" size="text-[10px] opacity-50" />
                                                </button>
                                            </div>
                                            {!(taskForm.leaveType === 'none' && taskForm.tripType === 'sehala') && (
                                                <div className="space-y-1">
                                                    <label className={`text-[9px] font-black uppercase opacity-70 ml-1 ${txtPrimary}`}>Pulang</label>
                                                    <input type="date" className={inputClass} value={taskForm.endDate || ''} onChange={e => setTaskForm({...taskForm, endDate: e.target.value})} />
                                                    <button type="button" onClick={() => openTimePicker('returnTime', taskForm.returnTime)} className={`${inputClass} mt-1 w-full text-left flex items-center justify-between`}>
                                                        <span>{format12h(taskForm.returnTime)}</span><UIcon type="clock" size="text-[10px] opacity-50" />
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                        <input type="text" className={inputClass + ' uppercase'} value={taskForm.destination || ''} placeholder="DESTINASI" onChange={e => setTaskForm({...taskForm, destination: e.target.value.toUpperCase()})} />
                                        <input type="text" className={inputClass} value={taskForm.matter || ''} placeholder="URUSAN" onChange={e => setTaskForm({...taskForm, matter: e.target.value})} />
                                        
                                        <div className={`grid grid-cols-1 gap-2 border-t pt-3 ${isDarkMode ? 'border-slate-700' : 'border-slate-200/20'}`}>
                                            <div className="flex items-center justify-between">
                                                <label className={`text-[9px] font-black uppercase opacity-70 ml-1 ${txtPrimary}`}>Jumlah Penumpang (Pax)</label>
                                                <div className="flex items-center gap-2">
                                                    <button type="button" onClick={() => handlePaxCountChange((taskForm.paxCount || 0) - 1)} className={`w-8 h-8 flex items-center justify-center rounded-lg font-black active:scale-95 transition-colors ${isDarkMode ? 'bg-slate-700 hover:bg-slate-600 text-white' : 'bg-slate-200 hover:bg-slate-300 text-slate-800'}`}>-</button>
                                                    <input type="number" min="0" className={`${inputClass} w-16 p-1.5 text-center`} value={taskForm.paxCount ?? 0} onChange={e => handlePaxCountChange(e.target.value)} />
                                                    <button type="button" onClick={() => handlePaxCountChange((taskForm.paxCount || 0) + 1)} className={`w-8 h-8 flex items-center justify-center rounded-lg font-black active:scale-95 transition-colors ${isDarkMode ? 'bg-slate-700 hover:bg-slate-600 text-white' : 'bg-slate-200 hover:bg-slate-300 text-slate-800'}`}>+</button>
                                                </div>
                                            </div>
                                            
                                            {taskForm.paxCount > 0 && (
                                                <div className="space-y-2 mt-2">
                                                    {(Array.isArray(taskForm.paxNames) ? taskForm.paxNames : []).map((name, idx) => (
                                                        <div key={idx} className="flex items-center gap-3">
                                                            <span className={`text-[10px] font-black opacity-50 w-4 text-right ${txtPrimary}`}>{idx + 1}.</span>
                                                            <input type="text" className={`${inputClass} p-2 flex-grow`} value={name || ''} placeholder={`Nama penumpang ke-${idx + 1}...`} onChange={e => {
                                                                const newNames = [...taskForm.paxNames];
                                                                newNames[idx] = e.target.value;
                                                                setTaskForm({...taskForm, paxNames: newNames});
                                                            }} />
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <textarea rows="2" className={inputClass + ' italic'} value={taskForm.notes || ''} placeholder="Catatan..." onChange={e => setTaskForm({...taskForm, notes: e.target.value})}></textarea>
                                    
                                    <button onClick={handleSave} disabled={isSaving} className={`w-full py-4 text-white rounded-xl font-black uppercase text-xs btn-3d active:scale-95 flex items-center justify-center gap-2 ${isDarkMode ? 'bg-amber-500 border-amber-600 text-slate-900' : 'bg-slate-950 border-slate-900'}`}><UIcon type={isSaving ? "refresh" : "checkCircle"} className={isSaving ? "loader-spin" : (isDarkMode ? "text-slate-900" : "text-green-400")} /> Simpan Maklumat</button>
                                </div>
                             </div>
                        </div>
                    )}

                    {/* DELETE CONFIRMATION MODAL */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 z-[300] bg-black/90 flex items-center justify-center p-4 text-white text-center">
                            <div className="bg-slate-900 border-2 border-red-600 p-8 rounded-3xl max-w-sm shadow-2xl">
                                <UIcon type="warn" size="text-5xl" className="text-red-500 mb-4 block mx-auto animate-pulse" />
                                <h3 className="text-xl font-black uppercase text-white mb-2">Padam Rekod?</h3>
                                <p className="text-xs text-white opacity-60 mb-8 font-bold uppercase tracking-widest">Maklumat ini akan dipadam kekal.</p>
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={handleFinalDelete} className="py-3 bg-red-600 text-white rounded-xl font-black uppercase text-xs btn-3d border-red-700">Ya</button>
                                    <button onClick={() => setShowDeleteConfirm(false)} className="py-3 bg-slate-700 text-white rounded-xl font-black uppercase text-xs btn-3d border-slate-600">Batal</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL: DRIVER SUMMARY INDIVIDU */}
                    {showDriverSummary && activeDriver && (
                        <div className="fixed inset-0 z-[160] bg-black/80 backdrop-blur-sm flex items-center justify-center p-3 print-area">
                            <div className={`w-full max-w-3xl p-6 sm:p-8 rounded-3xl border shadow-2xl print:shadow-none print:border-none ${bgPanel}`}>
                                <div className={`flex justify-between items-center mb-6 ${txtPrimary}`}>
                                    <h2 className="text-xl sm:text-2xl font-black uppercase italic tracking-tighter">{activeDriver.name}</h2>
                                    <button onClick={() => setShowDriverSummary(false)} className="p-1 rounded hover:bg-white/10 print-hidden"><UIcon type="x" size="text-sm" /></button>
                                </div>
                                <div className="space-y-3 max-h-[65vh] overflow-y-auto pr-1 custom-scrollbar print:max-h-none print:overflow-visible">
                                    {weekDays.map(date => {
                                        const dStr = getISODate(date);
                                        const dTasks = tasks.filter(t => t.driverId === activeDriver.id && t.startDate <= dStr && t.endDate >= dStr).sort((a, b) => a.startTime.localeCompare(b.startTime));
                                        return (
                                            <div key={date.toString()} className={`p-4 rounded-xl border flex gap-4 sm:gap-6 items-center shadow-sm print:border-black print:rounded-none print:shadow-none ${bgSubPanel} ${txtPrimary}`}>
                                                <div className={`w-16 sm:w-20 text-center border-r pr-4 sm:pr-6 print:border-black ${isDarkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                                                    <p className={`text-[10px] font-black uppercase ${isDarkMode ? 'text-amber-400' : 'text-indigo-600'}`}>{date.toLocaleDateString('ms-MY', {weekday:'short'})}</p>
                                                    <p className="text-xl sm:text-2xl font-black">{date.getDate()}</p>
                                                </div>
                                                <div className="flex-grow space-y-2">
                                                    {dTasks.length > 0 ? dTasks.map(t => (
                                                        <div key={t.id} className={`border-l-2 pl-3 py-1 print:border-black ${t.leaveType === 'rehat' ? 'border-yellow-500' : t.leaveType === 'sakit' ? 'border-red-500' : (isDarkMode ? 'border-amber-400' : 'border-indigo-600')}`}>
                                                            <div className="flex justify-between items-start mb-0.5">
                                                                <p className={`font-black text-[10px] sm:text-xs ${t.leaveType === 'rehat' ? 'text-yellow-600' : t.leaveType === 'sakit' ? 'text-red-500' : (isDarkMode ? 'text-blue-300' : 'text-blue-700')}`}>
                                                                    {format12h(t.startTime)} {!(t.leaveType === 'none' && t.tripType === 'sehala') && `‚Äî ${format12h(t.returnTime)}`}
                                                                </p>
                                                                <div className="flex gap-1 items-center">
                                                                    {t.leaveType === 'none' && t.tripType && (
                                                                        <span className={`text-[7px] sm:text-[8px] font-black uppercase px-1.5 py-0.5 rounded border ${getTripTypeColor(t.tripType)}`}>
                                                                            {getTripTypeLabel(t.tripType)}
                                                                        </span>
                                                                    )}
                                                                    {t.paxCount > 0 && t.leaveType === 'none' && (
                                                                        <span className={`text-[8px] sm:text-[10px] font-black px-1.5 py-0.5 rounded ${isDarkMode ? 'bg-slate-700 text-slate-300' : 'bg-slate-200 text-slate-700'}`}><UIcon type="pax" size="text-[8px]"/> {t.paxCount} Pax</span>
                                                                    )}
                                                                    {t.leaveType !== 'none' && <span className={`text-[7px] sm:text-[9px] text-white px-2 py-0.5 rounded font-black uppercase ${t.leaveType === 'rehat' ? 'bg-yellow-600' : 'bg-red-600'}`}>{t.leaveType === 'rehat' ? 'CUTI REHAT' : 'CUTI SAKIT'}</span>}
                                                                </div>
                                                            </div>
                                                            <p className="font-black text-sm sm:text-base uppercase leading-tight mb-0.5">{t.leaveType !== 'none' ? t.matter : (t.destination || 'Tiada Destinasi')}</p>
                                                            {t.leaveType === 'none' && (
                                                                <p className={`text-[9px] sm:text-[10px] font-bold uppercase ${txtSecondary} flex flex-col`}>
                                                                    <span>Urusan: {t.matter || '-'}</span>
                                                                    {t.paxCount > 0 && <span>Penumpang: {getPaxNamesString(t.paxNames) || 'Tiada Nama'}</span>}
                                                                </p>
                                                            )}
                                                        </div>
                                                    )) : <p className={`text-[10px] uppercase font-black italic opacity-30 ${txtPrimary}`}>Kosong</p>}
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                                <div className="mt-6 flex gap-3 print-hidden text-white">
                                    <button onClick={() => window.print()} className={`flex-grow py-4 rounded-xl font-black uppercase text-xs btn-3d active:scale-95 flex items-center justify-center gap-2 ${isDarkMode ? 'bg-blue-600 border-blue-700' : 'bg-indigo-600 border-indigo-700'}`}><UIcon type="file" size="text-sm" /> Jana Laporan PDF</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL: DAILY SUMMARY */}
                    {showDailySummary && selectedDateForSummary && (
                        <div className="fixed inset-0 z-[180] bg-black/80 backdrop-blur-sm flex items-center justify-center p-3">
                            <div className={`w-full max-w-xl p-6 rounded-3xl border shadow-2xl ${bgPanel} ${txtPrimary}`}>
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-lg sm:text-xl font-black uppercase italic tracking-tighter">Tugasan Harian: {selectedDateForSummary.toLocaleDateString('ms-MY', {day:'numeric', month:'short'})}</h2>
                                    <button onClick={() => setShowDailySummary(false)} className="p-1 rounded hover:bg-white/10"><UIcon type="x" size="text-base" /></button>
                                </div>
                                <div className="space-y-2 max-h-[60vh] overflow-y-auto pr-1">
                                    {tasks.filter(t => t.startDate <= getISODate(selectedDateForSummary) && t.endDate >= getISODate(selectedDateForSummary)).sort((a,b) => a.startTime.localeCompare(b.startTime)).map(t => {
                                        const drv = drivers.find(d=>d.id===t.driverId);
                                        const isRehat = t.leaveType === 'rehat';
                                        const isSakit = t.leaveType === 'sakit';
                                        const cardBg = isRehat ? (isDarkMode ? 'bg-yellow-900/40 border-yellow-700' : 'bg-yellow-50 border-yellow-200') : isSakit ? (isDarkMode ? 'bg-red-900/40 border-red-700' : 'bg-red-50 border-red-200') : bgSubPanel;
                                        
                                        return (
                                            <div key={t.id} className={`p-3 rounded-xl border flex justify-between items-center shadow-sm ${cardBg}`}>
                                                <div className="flex-grow pr-2">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <p className={`text-[10px] font-black uppercase ${isRehat ? 'text-yellow-600' : isSakit ? 'text-red-500' : (isDarkMode ? 'text-amber-400' : 'text-indigo-600')}`}>{drv?.name || 'Pemandu'}</p>
                                                        {t.leaveType === 'none' && t.tripType && (
                                                            <span className={`text-[6px] font-black uppercase px-1.5 py-0.5 rounded border ${getTripTypeColor(t.tripType)}`}>
                                                                {getTripTypeLabel(t.tripType)}
                                                            </span>
                                                        )}
                                                        {t.leaveType !== 'none' && <span className={`text-[7px] px-2 py-0.5 rounded uppercase font-black ${isRehat ? (isDarkMode ? 'bg-yellow-700 text-white' : 'bg-yellow-200 text-yellow-800') : (isDarkMode ? 'bg-red-700 text-white' : 'bg-red-200 text-red-800')}`}>{isRehat ? 'Cuti Rehat' : 'Cuti Sakit'}</span>}
                                                    </div>
                                                    <p className="text-xs font-black uppercase leading-tight">{t.leaveType !== 'none' ? t.matter : (t.destination || 'Aktiviti')}</p>
                                                </div>
                                                <div className={`text-right p-2 rounded-lg border min-w-[90px] flex flex-col justify-center ${isRehat ? (isDarkMode ? 'bg-yellow-900/50 border-yellow-700' : 'bg-yellow-100 border-yellow-300') : isSakit ? (isDarkMode ? 'bg-red-900/50 border-red-700' : 'bg-red-100 border-red-300') : (isDarkMode ? 'bg-slate-900 border-slate-700' : 'bg-slate-50 border-slate-100')}`}>
                                                    <p className={`text-[10px] font-black ${isRehat ? 'text-yellow-600' : isSakit ? 'text-red-500' : (isDarkMode ? 'text-blue-400' : 'text-blue-700')}`}>{format12h(t.startTime)}</p>
                                                    {t.leaveType === 'none' && t.tripType !== 'sehala' && <p className={`text-[8px] font-bold opacity-60 mt-0.5 ${isDarkMode ? 'text-blue-300' : 'text-blue-600'}`}>Hingga {format12h(t.returnTime)}</p>}
                                                    {t.leaveType === 'none' && t.tripType === 'sehala' && <p className={`text-[8px] font-bold opacity-60 mt-0.5 ${isDarkMode ? 'text-blue-300' : 'text-blue-600'}`}>Hantar Sahaja</p>}
                                                </div>
                                            </div>
                                        );
                                    })}
                                    {tasks.filter(t => t.startDate <= getISODate(selectedDateForSummary) && t.endDate >= getISODate(selectedDateForSummary)).length === 0 && (
                                        <div className="py-12 text-center opacity-30 uppercase font-black text-sm italic tracking-widest">Tiada Tugas</div>
                                    )}
                                </div>
                                <button onClick={() => setShowDailySummary(false)} className={`w-full py-4 rounded-xl font-black uppercase text-xs mt-4 active:scale-95 btn-3d ${isDarkMode ? 'bg-slate-700 text-white border-slate-600' : 'bg-slate-900 text-white border-slate-950'}`}>Tutup</button>
                            </div>
                        </div>
                    )}

                    <footer className={`mt-12 p-6 text-center border-t print-hidden font-black ${isDarkMode ? 'border-slate-800 opacity-50 text-slate-400' : 'border-slate-200 opacity-30 text-slate-950'}`}>
                        <p className="text-[9px] uppercase tracking-[0.5em]">Sistem Rekod Bersepadu Pemandu ‚Ä¢ v48 ‚Ä¢ USER ID: {user?.uid}</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
