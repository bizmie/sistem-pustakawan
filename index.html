<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pustakawan Digital</title>
    <style>
        :root {
            /* --- TEMA MATERIAL / ANDROID PIXEL (CERAH) --- */
            --bg-body: #F8F9FA;         
            --surface: #FFFFFF;         
            
            --primary: #1A73E8; 
            --primary-hover: #1557B0;
            --primary-light: #E8F0FE;
            
            --success: #1E8E3E;
            --danger: #D93025;
            --danger-light: #FCE8E6;
            --warning: #F9AB00;
            
            --text-main: #202124;       
            --text-muted: #5F6368;      
            --border: #DADCE0;          

            --radius-card: 12px;
            --radius-btn: 6px;
            --shadow-sm: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            
            --bg-weekend: #F1F3F4; 
            --bg-weekday: #FFFFFF; 

            --badge-active-bg: #E8F0FE; --badge-active-text: #1967D2; --badge-active-border: #8AB4F8;
            --badge-late-bg: #FCE8E6; --badge-late-text: #C5221F; --badge-late-border: #F28B82;
            --badge-done-bg: #E6F4EA; --badge-done-text: #137333; --badge-done-border: #81C995;

            --bg-kayu: rgba(249, 171, 0, 0.1);
            --bg-bukan-kayu: rgba(26, 115, 232, 0.05);

            --font-family: 'Google Sans', 'Product Sans', Roboto, 'Segoe UI', system-ui, sans-serif;
        }

        /* --- TEMA MATERIAL / ANDROID PIXEL (GELAP AUTOMATIK) --- */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #202124;         
                --surface: #292A2D; 
                
                --primary: #8AB4F8;         
                --primary-hover: #A8C7FA;
                --primary-light: rgba(138, 180, 248, 0.15);
                
                --success: #81C995;
                --danger: #F28B82;
                --danger-light: rgba(242, 139, 130, 0.15);
                --warning: #FDD663;
                
                --text-main: #E8EAED;       
                --text-muted: #9AA0A6;      
                --border: #5F6368;          

                --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.3), 0 1px 3px 1px rgba(0,0,0,0.15);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
                
                --bg-weekend: #303134; 
                --bg-weekday: #292A2D;

                --badge-active-bg: rgba(138, 180, 248, 0.15); --badge-active-text: #8AB4F8; --badge-active-border: rgba(138, 180, 248, 0.3);
                --badge-late-bg: rgba(242, 139, 130, 0.15); --badge-late-text: #F28B82; --badge-late-border: rgba(242, 139, 130, 0.3);
                --badge-done-bg: rgba(129, 201, 149, 0.15); --badge-done-text: #81C995; --badge-done-border: rgba(129, 201, 149, 0.3);

                --bg-kayu: rgba(253, 214, 99, 0.1); 
                --bg-bukan-kayu: rgba(138, 180, 248, 0.08);
            }
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            line-height: 1.4;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
        }

        /* --- LOGIN SCREEN --- */
        #loginView {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 90vh;
            flex-direction: column;
        }

        .login-card {
            background: var(--surface);
            padding: 30px 20px;
            border-radius: var(--radius-card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            width: 100%;
            max-width: 340px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .login-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 4px;
            background: var(--primary);
        }

        .login-input {
            width: 100%; padding: 10px; margin-bottom: 12px;
            border: 1px solid var(--border); border-radius: var(--radius-btn);
            background: var(--bg-body); color: var(--text-main);
            box-sizing: border-box; transition: 0.2s; font-family: inherit; font-size: 0.95rem;
        }
        .login-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-light); background: var(--surface); }

        .login-footer-info { margin-top: 20px; padding-top: 10px; border-top: 1px solid var(--border); font-size: 0.75rem; color: var(--text-muted); }

        /* --- DASHBOARD --- */
        #dashboardView { display: none; }
        .container { max-width: 1200px; margin: 0 auto; }

        /* --- HEADER --- */
        header {
            background: var(--surface); padding: 12px 20px;
            border-radius: var(--radius-card); border: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 15px; box-shadow: var(--shadow-sm); 
        }

        .logo-section h1 {
            margin: 0; font-size: 1.4rem; color: var(--text-main); 
            font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
            display: flex; align-items: center; gap: 8px;
        }
        .logo-section span { color: var(--primary); }
        .logo-section p { margin: 2px 0 0 42px; color: var(--text-muted); font-size: 0.85rem; font-weight: 500; }
        
        .header-right { text-align: right; }
        #headerDate { color: var(--primary); font-size: 0.95rem; font-weight: 600; text-transform: uppercase; margin-bottom: 4px; }
        .header-actions { display: flex; gap: 8px; justify-content: flex-end; align-items: center;}

        /* --- BUTTONS --- */
        .btn-3d {
            background: var(--primary); border: none; color: white;
            padding: 8px 14px; border-radius: var(--radius-btn); font-weight: 500;
            cursor: pointer; box-shadow: var(--shadow-sm); transition: 0.2s;
            display: inline-flex; align-items: center; gap: 6px; font-size: 0.85rem; font-family: inherit;
        }
        .btn-3d:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-3d:active { transform: translateY(0); box-shadow: none; }
        
        .btn-3d.secondary { background: transparent; color: var(--primary); border: 1px solid var(--border); box-shadow: none; }
        .btn-3d.secondary:hover { background: var(--primary-light); border-color: var(--primary); }
        
        .btn-3d.danger { background: transparent; color: var(--danger); border: 1px solid var(--border); box-shadow: none; }
        .btn-3d.danger:hover { background: var(--danger-light); border-color: var(--danger); }

        .btn-clear { background: var(--bg-body); border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; padding: 6px 12px; border-radius: var(--radius-btn); font-weight: 500; transition: 0.2s; font-family: inherit; display: inline-flex; align-items: center; justify-content: center; font-size: 0.85rem;}
        .btn-clear:hover { background: var(--danger-light); color: var(--danger); border-color: var(--danger); }

        /* --- NAVIGATION --- */
        .nav-tabs { display: flex; gap: 6px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 0; overflow-x: auto; scrollbar-width: none; }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .nav-btn {
            background: transparent; color: var(--text-muted); border: 1px solid transparent; border-bottom: none;
            padding: 10px 16px; font-size: 0.95rem; font-weight: 500; cursor: pointer; 
            border-radius: 8px 8px 0 0; transition: 0.2s; margin-bottom: -1px; white-space: nowrap; font-family: inherit;
        }
        .nav-btn:hover { background: var(--bg-body); color: var(--text-main); }
        .nav-btn.active {
            background: var(--surface); color: var(--primary); 
            border-color: var(--border); border-bottom-color: var(--surface);
            box-shadow: 0 3px 0 0 var(--primary) inset; 
        }

        /* --- SECTIONS --- */
        .tab-content { display: none; animation: fadeIn 0.2s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- STATS & CALENDAR --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px; }
        .stat-card {
            background: var(--surface); padding: 15px;
            border-radius: var(--radius-card); border: 1px solid var(--border);
            display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow-sm); 
        }
        .stat-icon {
            width: 42px; height: 42px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 1.3rem;
            background: var(--bg-body); border: 1px solid var(--border);
        }
        .stat-info h3 { margin: 0; font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;}
        .stat-info .value { font-size: 1.5rem; font-weight: 600; color: var(--text-main); margin-top: 0px;}
        
        .stat-card.clickable { cursor: pointer; transition: 0.2s; }
        .stat-card.clickable:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: var(--shadow-md); }

        .dashboard-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; }
        .calendar-card, .widget-card {
            background: var(--surface); padding: 15px;
            border-radius: var(--radius-card); border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .cal-header h3 { margin: 0; color: var(--text-main); font-weight: 500; font-size: 1.05rem;}
        
        .cal-grid-headers, .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-grid-headers { text-align: center; font-weight: 600; color: var(--text-muted); font-size: 0.75rem; margin-bottom: 8px; text-transform: uppercase;}
        
        .cal-day {
            background: var(--bg-body); border: 1px solid transparent;
            border-radius: var(--radius-btn); padding: 4px 2px; min-height: 48px;
            text-align: center; font-size: 0.9rem; font-weight: 400;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            transition: 0.2s;
        }
        .cal-day.weekend { background-color: var(--bg-weekend); }
        .cal-day.today { border: 2px solid var(--primary); background: var(--primary-light); color: var(--primary); font-weight: 600; }
        .cal-day.clickable:hover { background: var(--primary-light); border-color: var(--primary); cursor: pointer; transform: scale(1.05); z-index: 2; }
        
        .cal-dots { display: flex; gap: 2px; margin-top: 3px; justify-content: center; flex-wrap: wrap; }
        .cal-dot { width: 5px; height: 5px; border-radius: 50%; display: inline-block; }
        .cal-dot.red { background-color: var(--danger); } 
        .cal-dot.green { background-color: var(--success); } 

        .widget-item { 
            background: var(--bg-body); border: 1px solid var(--border); 
            padding: 10px 12px; border-radius: 8px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; font-weight: 500;
        }
        .search-shortcut-btn {
            cursor: pointer; display: inline-flex; justify-content: center; align-items: center;
            width: 28px; height: 28px; border-radius: 50%;
            background: var(--surface); border: 1px solid var(--border);
            font-size: 0.85rem; color: var(--primary); transition: 0.2s;
        }
        .search-shortcut-btn:hover { background: var(--primary-light); border-color: var(--primary); }

        /* --- TABLE --- */
        .content-card { background: var(--surface); border-radius: var(--radius-card); border: 1px solid var(--border); overflow: hidden; box-shadow: var(--shadow-sm); }
        .toolbar { padding: 12px 15px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; justify-content: space-between; background: var(--surface); flex-wrap: wrap; align-items: center;}
        
        .search-container { flex: 1; display: flex; gap: 6px; min-width: 250px; align-items: center; }
        .search-input { flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-btn); background: var(--bg-body); color: var(--text-main); font-family: inherit; font-size: 0.9rem;}

        .action-wrapper { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
        
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: var(--bg-body); text-align: left; padding: 10px 12px; color: var(--text-muted); border-bottom: 1px solid var(--border); font-size: 0.8rem; font-weight: 600; letter-spacing: 0.3px; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; vertical-align: top; color: var(--text-main); }
        tr:hover td { background-color: rgba(0,0,0,0.02); }
        [data-theme="dark"] tr:hover td { background-color: rgba(255,255,255,0.02); }

        .filter-chips { display: flex; gap: 8px; padding: 10px 15px; border-bottom: 1px solid var(--border); background: var(--surface); overflow-x: auto; scrollbar-width: none;}
        .chip { background: var(--bg-body); border: 1px solid var(--border); padding: 5px 12px; border-radius: 20px; cursor: pointer; color: var(--text-muted); font-weight: 500; font-size: 0.85rem; transition: 0.2s; white-space: nowrap; font-family: inherit;}
        .chip:hover { background: var(--border); }
        .chip.active { background: var(--primary-light); color: var(--primary); border-color: var(--primary); font-weight: 600; }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: 0.2s; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal { background: var(--surface); width: 100%; max-width: 600px; padding: 20px; border-radius: var(--radius-card); border: 1px solid var(--border); box-shadow: var(--shadow-md); max-height: 90vh; overflow-y: auto;}
        
        .grid-compact { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .col-span-2 { grid-column: span 2; }
        
        /* 4 Columns specific layout for Book Modal */
        .grid-cols-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .col-span-4 { grid-column: span 4; }
        .col-span-3 { grid-column: span 3; }
        .col-span-1 { grid-column: span 1; }

        .form-group label { display: block; margin-bottom: 4px; font-weight: 500; font-size: 0.85rem; color: var(--text-muted); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: var(--radius-btn); background: var(--bg-body); color: var(--text-main); box-sizing: border-box; font-size: 0.9rem; font-family: inherit; transition: 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px var(--primary-light); background: var(--surface); }

        #autosave-indicator { position: fixed; top: 15px; right: 15px; background: var(--surface); color: var(--success); padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 6px; opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; z-index: 9999; border: 1px solid var(--border); box-shadow: var(--shadow-sm); pointer-events: none; }

        @media (max-width: 768px) {
            .dashboard-layout, .grid-compact { grid-template-columns: 1fr; }
            .grid-cols-4 { grid-template-columns: 1fr; }
            .col-span-1, .col-span-2, .col-span-3, .col-span-4 { grid-column: span 1; }
            header { flex-direction: column; text-align: center; gap: 12px; padding: 15px;}
            .header-right { align-items: center; text-align: center; justify-content: center; width: 100%;}
            .header-actions { justify-content: center; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .action-wrapper { justify-content: space-between; width: 100%; }
            .search-container { width: 100%; }
            
            table, thead, tbody, th, td, tr { display: block; width: 100%; box-sizing: border-box; }
            thead tr { display: none; }
            tr { margin-bottom: 12px; border: 1px solid var(--border); padding: 12px; border-radius: var(--radius-card); background: var(--surface); box-shadow: var(--shadow-sm);}
            td { display: flex; flex-direction: column; text-align: left; padding: 6px 0; border-bottom: 1px dashed var(--border); }
            td:last-child { border-bottom: none; }
            td::before { content: attr(data-label); font-weight: 500; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 2px; }
        }
    </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginView">
    <div class="login-card">
        <div style="font-size: 3rem; margin-bottom: 10px; line-height:1;">üìö</div>
        <h1 style="color: var(--text-main); margin-bottom: 5px; font-size: 1.4rem; font-weight: 500;" class="app-title-display">SISTEM PUSTAKAWAN</h1>
        <p style="color: var(--text-muted); margin-bottom: 25px; font-size: 0.9rem;">Pengurusan Pinjaman Digital</p>
        
        <div style="text-align: left;">
            <input type="text" id="username" class="login-input" placeholder="ID Pengguna" value="admin" title="Masukkan ID pengguna rasmi">
            <input type="password" id="password" class="login-input" placeholder="Kata Laluan" value="admin123" title="Masukkan kata laluan" style="margin-bottom: 20px;">
        </div>
        
        <button class="btn-3d" type="button" style="width: 100%; justify-content: center; padding: 10px; font-size: 0.95rem;" onclick="window.attemptLogin()" title="Log masuk ke dalam sistem">Log Masuk</button>
    </div>
</div>

<!-- Dashboard -->
<div id="dashboardView">
    <div id="autosave-indicator">
        <span id="autosave-icon" style="font-size: 1rem;">üíæ</span> <span id="autosave-text">Data Tersimpan</span>
    </div>

    <div class="container">
        <!-- Header -->
        <header>
            <div class="logo-section">
                <h1><span style="font-size: 1.8rem;">üìö</span> <div class="app-title-display">SISTEM PUSTAKAWAN</div></h1>
                <p>Pengurusan Pinjaman Buku & Media</p>
            </div>
            
            <div class="header-right">
                <div id="headerDate"></div>
                <div class="header-actions">
                    <small id="statusText" style="color:var(--success); margin-right:5px; font-weight:500; display: flex; align-items: center;" title="Status talian pelayan awan">üåê Dalam Talian</small>
                    <button class="btn-3d secondary" type="button" onclick="window.switchTab('tetapan')" title="Buka halaman tetapan sistem">‚öôÔ∏è Tetapan</button>
                    <button class="btn-3d danger" type="button" onclick="location.reload()" title="Log keluar dari sesi ini">Keluar</button>
                </div>
            </div>
        </header>

        <div class="nav-tabs">
            <button class="nav-btn active" id="btn-dashboard" onclick="window.switchTab('dashboard')" title="Papar ringkasan dan statistik utama">üìä Dashboard Utama</button>
            <button class="nav-btn" id="btn-senarai" onclick="window.switchTab('senarai')" title="Papar dan urus senarai pinjaman">üìñ Rekod Pinjaman</button>
            <button class="nav-btn" id="btn-buku" onclick="window.switchTab('buku')" title="Papar dan urus bahan rujukan baharu">üìö Bahan Rujukan Baharu</button>
        </div>

        <!-- SEKSYEN 1: DASHBOARD -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card clickable" onclick="window.clickStatCard('aktif')" title="Tapis senarai pinjaman yang sedang dipinjam">
                    <div class="stat-icon" style="color: var(--primary); background: var(--primary-light); border-color: var(--primary-light);">üìñ</div>
                    <div class="stat-info">
                        <h3>Sedang Dipinjam</h3>
                        <div class="value" style="color: var(--primary);" id="statActive">0</div>
                    </div>
                </div>
                <div class="stat-card clickable" onclick="window.clickStatCard('lewat')" title="Tapis senarai pinjaman yang melepasi tarikh pulang">
                    <div class="stat-icon" style="color: var(--danger); background: var(--danger-light); border-color: var(--danger-light);">‚ö†Ô∏è</div>
                    <div class="stat-info">
                        <h3>Lewat (>14 Hari)</h3>
                        <div class="value" style="color: var(--danger);" id="statOverdue">0</div>
                    </div>
                </div>
                <div class="stat-card clickable" onclick="window.openFineModal()" title="Klik untuk lihat Laporan Denda Terperinci">
                    <div class="stat-icon" style="color: var(--warning); background: rgba(249, 171, 0, 0.15); border-color: rgba(249, 171, 0, 0.15);">üí∞</div>
                    <div class="stat-info">
                        <h3 style="text-transform:none;">Denda (<span id="dendaMonth">Bulan Ini</span>)</h3>
                        <div class="value" style="color: var(--warning);" id="statFine">RM 0.00</div>
                    </div>
                </div>
            </div>

            <div class="dashboard-layout">
                <div class="calendar-card">
                    <div class="cal-header">
                        <h3 id="calMonthYear">Bulan Tahun</h3>
                        <div class="cal-nav" style="display: flex; gap: 5px;">
                            <button class="btn-clear" onclick="window.changeMonth(-1)" title="Bulan sebelumnya">‚óÄ Prev</button>
                            <button class="btn-clear" onclick="window.changeMonth(1)" title="Bulan seterusnya">Next ‚ñ∂</button>
                        </div>
                    </div>
                    <div class="cal-grid-headers">
                        <div>Isnin</div><div>Selasa</div><div>Rabu</div><div>Khamis</div><div>Jumaat</div><div style="color:var(--danger)">Sabtu</div><div style="color:var(--danger)">Ahad</div>
                    </div>
                    <div class="cal-grid" id="calGrid"></div>
                    <div style="margin-top:15px; font-size:0.8rem; color:var(--text-muted); display:flex; gap:15px; justify-content:center;">
                        <span style="display:flex; align-items:center; gap:4px;"><span class="cal-dot green"></span> Mula Pinjam</span>
                        <span style="display:flex; align-items:center; gap:4px;"><span class="cal-dot red"></span> Tarikh Perlu Pulang</span>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div class="widget-card" style="padding: 15px;">
                        <h3 style="color: var(--text-main); margin-top:0; font-weight: 500; font-size: 1.05rem;">Ringkasan Status</h3>
                        <div id="notificationList" style="display: flex; flex-direction: column; gap: 6px; margin-top: 10px;">
                            <!-- Content injected by JS -->
                        </div>
                    </div>
                    
                    <div class="widget-card" style="padding: 15px;">
                        <h3 style="color: var(--text-main); margin-top:0; font-weight: 500; font-size: 1.05rem;">Bahan Baru (Bulan Ini)</h3>
                        <div id="newBooksWidgetList" style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px; max-height: 220px; overflow-y: auto; padding-right: 5px;">
                            <!-- Content injected by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SEKSYEN 2: SENARAI PINJAMAN -->
        <div id="tab-senarai" class="tab-content">
            <div class="content-card">
                <div class="toolbar">
                    <div class="search-container">
                        <input type="text" id="searchInput" class="search-input" placeholder="Cari nama peminjam, ID, atau tajuk..." onkeyup="window.renderTable()" title="Taip untuk mencari rekod pinjaman">
                        <button class="btn-clear" onclick="window.clearSearch()" title="Padam Carian">‚ùå</button>
                    </div>
                    
                    <div class="action-wrapper">
                        <div style="display:flex; align-items:center; gap:6px; background:var(--bg-body); padding:4px 8px; border-radius:var(--radius-btn); border:1px solid var(--border);">
                            <span style="font-size:0.8rem; font-weight:500; color:var(--text-muted);">Laporan:</span>
                            <select id="reportMonth" style="border:1px solid var(--border); background:var(--surface); color:var(--text-main); padding:4px 6px; border-radius:4px; font-family:inherit; font-size: 0.85rem;" title="Pilih Bulan Cetakan">
                                <option value="0">Januari</option><option value="1">Februari</option><option value="2">Mac</option>
                                <option value="3">April</option><option value="4">Mei</option><option value="5">Jun</option>
                                <option value="6">Julai</option><option value="7">Ogos</option><option value="8">September</option>
                                <option value="9">Oktober</option><option value="10">November</option><option value="11">Disember</option>
                            </select>
                            <input type="number" id="reportYear" value="2026" style="width:60px; border:1px solid var(--border); background:var(--surface); color:var(--text-main); padding:4px 6px; border-radius:4px; font-size: 0.85rem;" title="Pilih Tahun Cetakan">
                            <button class="btn-3d secondary" onclick="window.printMonthlyReport()" title="Jana dan cetak laporan PDF mengikut bulan terpilih">üñ®Ô∏è Cetak</button>
                        </div>
                        <button class="btn-3d" onclick="window.openModal()" style="background:var(--success); border-color:var(--success); font-size:0.95rem;" title="Buka borang untuk rekod pinjaman baharu">‚ûï Pinjaman Baru</button>
                    </div>
                </div>
                
                <div class="filter-chips">
                    <button id="chip-all" class="chip active" onclick="window.setFilter('all')" title="Papar semua rekod pinjaman">Semua Rekod</button>
                    <button id="chip-aktif" class="chip" onclick="window.setFilter('aktif')" title="Papar rekod yang masih belum dipulangkan">Belum Pulang</button>
                    <button id="chip-ok" class="chip" onclick="window.setFilter('ok')" title="Papar rekod yang masih dalam tempoh pinjaman">Dalam Tempoh</button>
                    <button id="chip-lewat" class="chip" onclick="window.setFilter('lewat')" title="Papar rekod pinjaman yang melebihi tarikh pulang">Lewat Pulang</button>
                </div>

                <div class="table-wrap"> 
                    <table id="mainTable">
                        <thead>
                            <tr>
                                <th style="width: 25%;">Maklumat Peminjam</th>
                                <th style="width: 30%;">Bahan / Tajuk</th>
                                <th style="width: 25%;">Tarikh & Tempoh</th>
                                <th style="width: 10%;">Status</th>
                                <th style="text-align: right; width: 10%;">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="5" style="text-align:center; padding: 30px;">Memuatkan data dari pangkalan data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SEKSYEN BARU: BAHAN RUJUKAN BAHARU -->
        <div id="tab-buku" class="tab-content">
            <div class="content-card">
                <div class="toolbar">
                    <div class="search-container">
                        <input type="text" id="searchBukuInput" class="search-input" placeholder="Cari tajuk buku, penerbit, atau kategori..." onkeyup="window.renderBukuTable()" title="Taip untuk mencari maklumat buku baharu">
                        <button class="btn-clear" onclick="document.getElementById('searchBukuInput').value=''; window.renderBukuTable();" title="Padam teks carian">‚ùå</button>
                    </div>

                    <div class="action-wrapper">
                        <div style="display:flex; align-items:center; gap:6px; background:var(--bg-body); padding:4px 8px; border-radius:var(--radius-btn); border:1px solid var(--border);">
                            <span style="font-size:0.8rem; font-weight:500; color:var(--text-muted);">Laporan Tahun:</span>
                            <input type="number" id="printBukuYear" value="2026" style="width:60px; border:1px solid var(--border); background:var(--surface); color:var(--text-main); padding:4px 6px; border-radius:4px; font-size: 0.85rem;" title="Pilih Tahun Cetakan Bahan Baru">
                            <button class="btn-3d secondary" onclick="window.printBukuReport()" title="Jana dan cetak senarai PDF bahan rujukan baharu">üñ®Ô∏è Cetak</button>
                        </div>
                        <button class="btn-3d" onclick="window.openBukuModal()" style="background:var(--success); border-color:var(--success); font-size:0.95rem;" title="Buka borang pendaftaran bahan rujukan baharu">‚ûï Rekod Buku Baru</button>
                    </div>
                </div>
                
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:12%">Tarikh</th>
                                <th style="width:25%">Tajuk & Edisi</th>
                                <th style="width:20%">Maklumat Bahan</th>
                                <th style="width:20%">Penerima / Sumber</th>
                                <th style="width:13%">Kategori</th>
                                <th style="text-align:right;">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="bukuTableBody">
                            <tr><td colspan="6" style="text-align:center; padding: 30px;">Memuatkan senarai bahan rujukan...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SEKSYEN 3: TETAPAN -->
        <div id="tab-tetapan" class="tab-content">
            <div class="content-card" style="padding: 20px;">
                <h2 style="margin-top:0; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; font-weight: 500; font-size: 1.2rem;">‚öôÔ∏è Tetapan Sistem Aplikasi</h2>
                
                <div style="max-width: 600px;">
                    <div style="margin-bottom: 20px;">
                        <label class="form-label" style="font-size: 0.95rem; color:var(--text-main); font-weight: 500;">Tajuk Utama Aplikasi</label>
                        <p style="font-size:0.85rem; color:var(--text-muted); margin: 4px 0 10px 0;">Ubah tajuk yang dipaparkan di bahagian atas halaman sistem.</p>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="setting_app_title" class="input-box" style="margin:0;" placeholder="SISTEM PUSTAKAWAN" title="Masukkan tajuk sistem perpustakaan anda">
                            <button class="btn-3d" onclick="window.saveAppTitle()" title="Simpan perubahan tajuk">üíæ Simpan</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding-top: 15px; border-top: 1px dashed var(--border);">
                        <label class="form-label" style="font-size: 0.95rem; color:var(--text-main); font-weight: 500;">Versi Aplikasi</label>
                        <p style="font-size:0.85rem; color:var(--text-muted); margin: 4px 0 10px 0; font-family: monospace; font-weight: 600;">PUSTAKA-V8.4-COMPACT</p>
                    </div>
                </div>

                <div style="background: var(--bg-body); padding: 20px; border-radius: var(--radius-card); border: 1px solid var(--border); margin-top: 30px; max-width: 600px;">
                    <h4 style="margin-top: 0; color: var(--text-main); font-weight: 500; font-size: 1.05rem;">Eksport Pangkalan Data (Sandaran)</h4>
                    <p style="font-size:0.85rem; color:var(--text-muted); margin-top:4px; margin-bottom: 15px;">Muat turun semua rekod ke dalam format fail .CSV untuk simpanan selamat (Backup).</p>
                    <div style="display:flex; gap:10px;">
                        <button onclick="window.exportDatabase()" class="btn-3d secondary" style="flex:1; justify-content:center;" title="Sandaran untuk Jadual Pinjaman">üì• Data Pinjaman</button>
                        <button onclick="window.exportBukuDatabase()" class="btn-3d secondary" style="flex:1; justify-content:center;" title="Sandaran untuk Jadual Buku Baru">üì• Data Buku Baru</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Urus Status & Edit Pinjaman (COMPACT VERSION) -->
<div class="modal-overlay" id="statusModal">
    <div class="modal">
        <div class="modal-header">
            <h3 id="sm_title" style="margin:0; color:var(--text-main); font-size:1.1rem; font-weight: 500;">Urus Pinjaman</h3>
            <button onclick="window.closeStatusModal()" style="background:none; border:none; color:var(--text-muted); font-size:1.5rem; cursor:pointer;" title="Tutup tetingkap ini">&times;</button>
        </div>
        <input type="hidden" id="docId">
        
        <div class="grid-compact">
            <div class="form-group"><label>Nama Peminjam</label><input type="text" id="em_nama" placeholder="Nama Penuh" title="Taip nama penuh peminjam bahan"></div>
            <div class="form-group"><label>ID / No. Pekerja</label><input type="text" id="em_noPekerja" placeholder="A001" title="Sila masukkan ID ahli atau No. pekerja jika ada"></div>
            
            <div class="form-group" style="position: relative;">
                <label>WhatsApp</label>
                <div style="display:flex; align-items:center;">
                    <input type="text" id="em_whatsapp" style="padding-right: 35px;" placeholder="601..." title="Pastikan bermula dengan 6 untuk link ke WhatsApp">
                    <a id="waLinkBtn" href="#" target="_blank" title="Buka di aplikasi WhatsApp Peminjam" style="position:absolute; right:5px; text-decoration:none; display:none;">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C6.48 2 2 6.48 2 12C2 13.85 2.5 15.55 3.35 17L2.25 21.05C2.15 21.45 2.55 21.85 2.95 21.75L7 20.65C8.45 21.5 10.15 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C10.45 20 9 19.6 7.75 18.85L4.8 19.65L5.6 16.7C4.85 15.45 4.45 14 4.45 12.45C4.45 8.35 7.8 5 11.95 5C16.1 5 19.45 8.35 19.45 12.45C19.45 16.55 16.1 19.9 12 19.9V20Z" fill="#1E8E3E"/>
                            <path d="M15.4 14.3C15.2 14.2 14.2 13.7 14 13.65C13.8 13.6 13.65 13.55 13.5 13.75C13.35 13.95 12.95 14.45 12.8 14.6C12.65 14.75 12.5 14.75 12.3 14.65C12.1 14.55 11.45 14.35 10.7 13.65C10.1 13.1 9.7 12.45 9.6 12.25C9.5 12.05 9.6 11.95 9.7 11.85C9.8 11.75 9.9 11.65 10 11.55C10.1 11.45 10.15 11.35 10.2 11.25C10.25 11.15 10.25 11.05 10.2 10.95C10.15 10.85 9.75 9.85 9.6 9.45C9.45 9.05 9.3 9.1 9.2 9.1H8.8C8.65 9.1 8.4 9.15 8.2 9.4C8 9.65 7.45 10.15 7.45 11.2C7.45 12.25 8.2 13.25 8.3 13.4C8.4 13.55 9.8 15.7 11.95 16.6C13.7 17.35 14.05 17.2 14.45 17.15C14.85 17.1 15.7 16.65 15.9 16.1C16.1 15.55 16.1 15.1 16.05 15C16 14.9 15.85 14.85 15.65 14.75H15.4V14.3Z" fill="#1E8E3E"/>
                        </svg>
                    </a>
                </div>
            </div>
            <div class="form-group"><label>Bahagian</label><input type="text" id="em_bahagian" placeholder="Cth: Kewangan" title="Masukkan bahagian/jabatan peminjam bekerja"></div>
            
            <div class="form-group"><label>Tajuk Bahan</label><input type="text" id="em_tajuk" placeholder="Tajuk Bahan" title="Sila taip tajuk penuh bahan yang dipinjam"></div>
            <div class="form-group"><label>Kategori</label><select id="em_jenis" title="Pilih kategori bahan"><option value="Buku">Buku</option><option value="Fail Dokumen">Fail Dokumen</option><option value="Majalah">Majalah</option><option value="Alat Bantu">Alat Bantu Mengajar</option></select></div>
        </div>

        <div style="background: var(--primary-light); padding: 12px; border-radius: var(--radius-btn); border: 1px solid rgba(26, 115, 232, 0.2); margin-top: 10px;">
            <div class="grid-compact">
                <div class="form-group">
                    <label style="color: var(--primary); font-weight: 600;">Tarikh Pinjam</label>
                    <input type="date" id="em_tPinjam" onchange="window.autoCalcReturnDateEdit(); window.recalcModalCalc()" title="Pilih tarikh bahan mula dipinjam">
                </div>
                <div class="form-group">
                    <label style="color: var(--primary); font-weight: 600;">Jangkaan Pulang</label>
                    <input type="date" id="sm_tPulang" style="border-color: var(--primary);" oninput="window.recalcModalCalc()" title="Tarikh automatik (+14 Hari)">
                </div>
            </div>
        </div>

        <div style="background: var(--bg-body); padding: 12px; border-radius: var(--radius-btn); border: 1px solid var(--border); margin-top: 10px;">
            <div class="form-group" style="margin-bottom: 0;">
                <label style="margin-bottom: 6px;">Status Pemulangan</label>
                <div style="display: flex; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: var(--text-main); font-size: 0.9rem;">
                        <input type="radio" name="sm_status_pulang" value="belum" id="radio_belum" onchange="window.toggleReturnDateInput()" title="Buku masih dipegang peminjam"> Belum Pulang
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: var(--success); font-size: 0.9rem; font-weight: 500;">
                        <input type="radio" name="sm_status_pulang" value="sudah" id="radio_sudah" onchange="window.toggleReturnDateInput()" title="Tandakan jika buku sudah diserahkan kembali"> Telah Dipulangkan
                    </label>
                </div>
            </div>

            <div class="form-group" id="div_actual_return_date" style="display:none; margin-top: 10px;">
                <label style="color:var(--success); font-weight: 600;">Tarikh Pemulangan Sebenar</label>
                <input type="date" id="em_tDipulangkan" oninput="window.recalcModalCalc()" onchange="window.recalcModalCalc()" style="border-color: var(--success);" title="Masukkan tarikh bilakah buku ini benar-benar dipulangkan">
            </div>
        </div>
        
        <div class="form-group" style="margin-top: 10px;">
            <label>Catatan / Komen Ringkas (Pilihan)</label>
            <textarea id="em_catatan" rows="2" placeholder="Nota tambahan..." title="Ruang tambahan untuk sebarang komen."></textarea>
        </div>
        
        <!-- Info Bar -->
        <div style="display:flex; gap:10px; margin-top:10px; font-size:0.85rem;">
            <div id="sm_duration_info" style="flex:1; background: var(--bg-body); padding: 8px; border-radius: var(--radius-btn); text-align:center; font-weight: 500; border:1px solid var(--border);"></div>
            <div id="sm_info_container" style="flex:1; background: var(--danger-light); padding: 8px; border-radius: var(--radius-btn); border: 1px dashed var(--danger); text-align:center; display:none; color:var(--danger); font-weight: 500;"></div>
        </div>

        <div style="display:flex; gap:10px; margin-top: 15px;">
            <button onclick="window.deleteRecord()" id="btnDelete" class="btn-3d danger" type="button" style="margin-right:auto;" title="Padam rekod ini secara kekal dari pangkalan data">üóëÔ∏è Hapus</button>
            <button onclick="window.closeStatusModal()" class="btn-3d secondary" type="button" title="Batal segala pindaan dan tutup borang">Batal</button>
            <button onclick="window.saveModalChanges()" class="btn-3d" type="button" style="padding-left: 20px; padding-right: 20px;" title="Simpan perubahan dan kemaskini ke Pangkalan Data">üíæ Simpan</button>
        </div>
    </div>
</div>

<!-- MODAL BAHAN RUJUKAN BAHARU -->
<div class="modal-overlay" id="bukuModal">
    <div class="modal" style="max-width: 750px;">
        <div class="modal-header">
            <h3 style="margin:0; font-size:1.2rem; font-weight: 600;">üìö Daftar Buku/Bahan Baru</h3>
        </div>
        <input type="hidden" id="bukuId">
        
        <div class="grid-cols-4">
            <div class="form-group col-span-2">
                <label class="form-label" style="color:var(--primary); font-weight: 600;">Kategori Penerimaan</label>
                <select id="b_kategori" class="form-input" style="border-color:var(--primary); font-weight: 500;" title="Pilih status penerimaan untuk klasifikasi aset">
                    <option value="Buku Percuma">üéÅ Bahan / Buku Percuma</option>
                    <option value="Pembelian Baru">üõí Pembelian Baru</option>
                </select>
            </div>

            <div class="form-group col-span-2">
                <label class="form-label">Tarikh Diterima</label>
                <input type="date" id="b_tarikh" class="form-input" title="Pilih tarikh bahan diterima oleh pusat sumber">
            </div>
            
            <div class="form-group col-span-4">
                <label class="form-label">Tajuk Bahan</label>
                <input type="text" id="b_tajuk" class="form-input" placeholder="Masukkan tajuk penuh rujukan" title="Wajib diisi - Nama atau tajuk rasmi bahan rujukan">
            </div>

            <div class="form-group col-span-2">
                <label class="form-label">Edisi / Isu</label>
                <input type="text" id="b_edisi" class="form-input" placeholder="Cth: Bil. 134/2025" title="Sila nyatakan siri keluaran, nombor isu atau versi edisi bahan ini">
            </div>

            <div class="form-group col-span-2">
                <label class="form-label">ISSN / ISBN</label>
                <input type="text" id="b_isbn" class="form-input" placeholder="Cth: ISBN 978-629-..." title="Masukkan kod pengenalan buku (International Standard Book Number)">
            </div>

            <!-- COMPACT ROW FOR SMALL DATA -->
            <div class="form-group col-span-1">
                <label class="form-label">Jenis Bahan</label>
                <select id="b_jenis" class="form-input" title="Klasifikasikan format bahan rujukan yang didaftarkan">
                    <option value="Buku">Buku</option>
                    <option value="Laporan">Laporan</option>
                    <option value="Majalah">Majalah</option>
                    <option value="Jurnal">Jurnal</option>
                    <option value="Lain-lain">Lain-lain</option>
                </select>
            </div>
            <div class="form-group col-span-1">
                <label class="form-label">Bilangan</label>
                <input type="number" id="b_bilangan" class="form-input" value="1" min="1" title="Nyatakan kuantiti (unit) bahan yang diterima untuk rekod inventori">
            </div>
            <div class="form-group col-span-1">
                <label class="form-label">Bidang</label>
                <select id="b_bidang" class="form-input" title="Tentukan samada bahan ini tergolong dalam bidang Perusahaan Kayu atau tidak">
                    <option value="Perusahaan Kayu" selected>Perusahaan Kayu</option>
                    <option value="Bukan Perusahaan Kayu">Bukan Perusahaan Kayu</option>
                </select>
            </div>
            <div class="form-group col-span-1">
                <label class="form-label">Penerbitan</label>
                <select id="b_penerbitan" class="form-input" title="Lokasi asal penerbitan rujukan tersebut dicetak">
                    <option value="Dalam Negara">Dalam Negara</option>
                    <option value="Luar Negara">Luar Negara</option>
                </select>
            </div>

            <div class="form-group col-span-2">
                <label class="form-label">Penerima</label>
                <input type="text" id="b_penerima" class="form-input" placeholder="Nama penerima bahan" title="Masukkan nama pegawai pusat sumber yang menerima aset ini">
            </div>
            <div class="form-group col-span-2">
                <label class="form-label">Perolehan Daripada (Sumber)</label>
                <input type="text" id="b_sumber" class="form-input" placeholder="Cth: MTIB / UITM / Syarikat XYZ" title="Nama agensi, syarikat, atau entiti dari mana bahan tersebut diperoleh">
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:25px; justify-content: flex-end; border-top: 1px solid var(--border); padding-top: 15px;">
            <button type="button" id="btnDeleteBuku" class="btn-3d danger" style="display:none; margin-right:auto;" onclick="window.deleteBuku()" title="Padam rekod pendaftaran buku ini secara kekal">üóëÔ∏è Hapus</button>
            <button type="button" class="btn-clear" style="border: 1px solid var(--danger); color: var(--danger); margin-right:auto;" onclick="window.closeBukuModal()" title="Batal segala pindaan dan tutup borang pendaftaran">‚ùå Tutup</button>
            <button type="button" class="btn-3d secondary" style="border-color: var(--warning); color: var(--warning); box-shadow: none;" onclick="window.saveBuku('KIV')" title="Simpan sebagai rekod sementara (KIV)">‚è≥ Simpan KIV</button>
            <button type="button" class="btn-3d" style="padding-left: 20px; padding-right: 20px;" onclick="window.saveBuku('Aktif')" title="Daftar buku ini ke dalam pangkalan data pusat sumber">üíæ Simpan Rekod</button>
        </div>
    </div>
</div>

<!-- MODAL LAPORAN DENDA KHUSUS -->
<div class="modal-overlay" id="fineModal">
    <div class="modal" style="max-width: 750px;">
        <div class="modal-header">
            <h3 style="margin:0; font-size:1.1rem; font-weight: 500;">üí∞ Laporan Terperinci Denda</h3>
            <button onclick="window.closeFineModal()" style="background:var(--bg-body); border:1px solid var(--border); width:30px; height:30px; border-radius:50%; font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center;" title="Tutup tetingkap laporan denda ini">&times;</button>
        </div>
        
        <div class="table-wrap" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius-card);">
            <table style="margin: 0; min-width: 600px;">
                <thead style="position: sticky; top: 0; z-index: 10;">
                    <tr>
                        <th style="width:5%; text-align:center;">No</th>
                        <th style="width:30%">Peminjam</th>
                        <th style="width:30%">Tajuk Bahan</th>
                        <th style="width:15%; text-align:center;">Lewat (Hari)</th>
                        <th style="width:10%; text-align:right;">Kadar Denda</th>
                        <th style="width:10%; text-align:center;">Status</th>
                    </tr>
                </thead>
                <tbody id="fineTableBody">
                    <!-- Diisi oleh JS -->
                </tbody>
            </table>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px; padding-top:15px; border-top:2px dashed var(--border);">
            <div style="font-size:1.05rem; font-weight:500;">Jumlah Keseluruhan: <span id="totalFineAmount" style="color:var(--danger); margin-left:8px; font-weight: 600;">RM 0.00</span></div>
            <div style="display:flex; gap:10px;">
                <button type="button" class="btn-3d secondary" onclick="window.closeFineModal()" title="Tutup paparan denda">Tutup</button>
                <button type="button" class="btn-3d" onclick="window.printFineReport()" title="Jana dokumen untuk cetak keseluruhan senarai denda">üñ®Ô∏è Cetak Senarai Denda</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- GLOBAL VARIABLES & STATE ---
    window.dbData = []; // Data Pinjaman
    window.dbBuku = []; // Data Buku Baru
    window.currentFilter = 'all';
    let calDateGlobal = new Date();
    let currId = null;

    const DB_KEY = 'pustakawan_db_v4.0_no_import';
    const DB_BUKU_KEY = 'pustakawan_buku_db_v1';
    const DENDA_PER_HARI = 0.20; 

    // Initialize Local Storage Fallback Data (If cloud is slow/unavailable)
    window.dbData = JSON.parse(localStorage.getItem(DB_KEY)) || [];
    window.dbBuku = JSON.parse(localStorage.getItem(DB_BUKU_KEY)) || [];

    if(window.dbBuku.length === 0) {
        window.dbBuku = [
            { id: 201, kategori: "Buku Percuma", tarikh: "2026-01-12", jenis: "Laporan", tajuk: "Laporan Timber Statistics Malaysia Export dan Import", edisi: "Januari - September 2025", bilangan: "1", isbn: "", bidang: "Perusahaan Kayu", penerbitan: "Dalam Negara", penerima: "Sharifah", sumber: "MTIB (BPS)", status_rekod: "Aktif" }
        ];
        localStorage.setItem(DB_BUKU_KEY, JSON.stringify(window.dbBuku));
    }

    // --- INITIALIZATION ---
    window.setupDateDisplay = function() {
        const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        const dateStr = new Date().toLocaleDateString('ms-MY', options).toUpperCase();
        if(document.getElementById('headerDate')) document.getElementById('headerDate').innerText = dateStr;
        if(document.getElementById('loginDate')) document.getElementById('loginDate').innerText = dateStr;
    }

    window.initTheme = function() {
        const savedTheme = localStorage.getItem('pustakawan_theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
    }

    window.loadAppTitle = function() {
        const title = localStorage.getItem('pustakawan_app_title') || 'SISTEM PUSTAKAWAN';
        document.querySelectorAll('.app-title-display').forEach(el => {
            el.innerText = title;
        });
        const inputSet = document.getElementById('setting_app_title');
        if(inputSet) inputSet.value = title;
    }

    document.addEventListener("DOMContentLoaded", () => {
        window.setupDateDisplay();
        window.loadAppTitle();
    });

    window.saveAppTitle = function() {
        const newTitle = document.getElementById('setting_app_title').value.trim() || 'SISTEM PUSTAKAWAN';
        localStorage.setItem('pustakawan_app_title', newTitle);
        window.loadAppTitle();
        alert("Tajuk aplikasi berjaya dikemaskini kepada: " + newTitle);
    }

    // --- LOGIN ---
    window.attemptLogin = function() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        if(u === 'admin' && p === 'admin123' || u === 'pustakawan' && p === 'pustakaMTIB') {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('dashboardView').style.display = 'block';
            
            if(window.initFirebase) window.initFirebase();
            window.renderCalendar();
            
            const now = new Date();
            if(document.getElementById('printMonth')) document.getElementById('printMonth').value = now.getMonth();
            if(document.getElementById('printYear')) document.getElementById('printYear').value = now.getFullYear();
        } else {
            alert("ID pengguna atau Kata Laluan salah.");
        }
    }

    // --- TABS & FILTER LOGIC ---
    window.switchTab = function(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        const tab = document.getElementById('tab-' + tabId);
        const btn = document.getElementById('btn-' + tabId);
        if (tab) tab.classList.add('active');
        if (btn) btn.classList.add('active');
        
        if (tabId === 'dashboard') window.renderCalendar();
    }

    window.goToTabFilter = function(filterType) {
        window.switchTab('senarai');
        window.setFilter(filterType);
    }

    window.setFilter = function(type) {
        window.currentFilter = type;
        document.querySelectorAll('.chip').forEach(el => el.classList.remove('active'));
        let chipId = 'chip-' + type;
        if (type === 'active') chipId = 'chip-aktif';
        if (type === 'late') chipId = 'chip-lewat';
        const chip = document.getElementById(chipId);
        if(chip) chip.classList.add('active');
        window.renderTable();
    }

    window.clearSearch = function() {
        const input = document.getElementById('searchInput');
        if(input) input.value = '';
        window.renderTable();
    }

    // --- UTILITIES ---
    window.formatDate = function(d) {
        if(!d) return '-';
        return d.split('-').reverse().join('/');
    }

    window.calculateDuration = function(start, end) {
        if(!start) return 0;
        const d1 = new Date(start);
        const d2 = end ? new Date(end) : new Date();
        d1.setHours(0,0,0,0); d2.setHours(0,0,0,0);
        return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
    }

    window.autoCalcReturnDateEdit = function() {
        const pinjamVal = document.getElementById('em_tPinjam').value;
        if (pinjamVal) {
            const pinjamDate = new Date(pinjamVal);
            pinjamDate.setDate(pinjamDate.getDate() + 14);
            document.getElementById('sm_tPulang').value = pinjamDate.toISOString().split('T')[0];
        }
    }

    // --- PINJAMAN: RENDER TABLE ---
    window.renderTable = function() {
        const tbody = document.getElementById('tableBody');
        if(!tbody) return;
        
        const search = document.getElementById('searchInput') ? document.getElementById('searchInput').value.toLowerCase() : '';
        tbody.innerHTML = '';

        const dataToRender = window.dbData.filter(item => {
            const text = (item.nama + item.tajuk + item.noPekerja + item.tPinjam + item.tPulang).toLowerCase();
            if(search && !text.includes(search)) return false;

            const dur = window.calculateDuration(item.tPinjam, item.status.includes('Selesai') ? item.tDipulangkan : null);
            const isLate = dur > 14;

            if(window.currentFilter === 'active' && item.status.includes('Selesai')) return false;
            if(window.currentFilter === 'ok' && (item.status.includes('Selesai') || isLate)) return false; 
            if(window.currentFilter === 'late' && (item.status.includes('Selesai') || !isLate)) return false; 
            return true;
        });

        if(dataToRender.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--text-muted);">Tiada rekod dijumpai.</td></tr>';
            return;
        }

        dataToRender.forEach(item => {
            const dur = window.calculateDuration(item.tPinjam, item.status.includes('Selesai') ? item.tDipulangkan : null);
            const isLate = dur > 14 && !item.status.includes('Selesai');
            
            let statusBadge = '';
            if(item.status.includes('Selesai')) {
                let dendaTxt = item.denda > 0 ? `<br><span style="color:var(--danger); font-size:0.75rem; margin-top:4px;">Denda: RM ${item.denda}</span>` : '';
                statusBadge = `<span class="badge-btn badge-done" title="Pegangan telah selesai">‚úÖ Dipulangkan${dendaTxt}</span>`;
            } else if(isLate) {
                statusBadge = `<span class="badge-btn badge-late" title="Peminjam tidak memulangkan bahan lebih dari 14 hari">‚ö†Ô∏è Lewat Pulang</span>`;
            } else {
                statusBadge = `<span class="badge-btn badge-active" title="Masih dalam tempoh pegangan">üü¢ Dipinjam</span>`;
            }

            const bhg = item.bahagian ? `<br><small style="color:var(--primary); font-weight:500;">[ ${item.bahagian} ]</small>` : '';

            const row = `
                <tr>
                    <td data-label="Peminjam"><strong style="color:var(--text-main); font-size:0.95rem;">${item.nama}</strong><br><small style="color:var(--text-muted);">${item.noPekerja}</small>${bhg}</td>
                    <td data-label="Bahan"><div style="font-weight:500; color:var(--text-main);">${item.tajuk}</div><small style="background:var(--bg-body); padding:2px 6px; border-radius:4px; border:1px solid var(--border); font-size:0.75rem;">${item.jenis}</small></td>
                    <td data-label="Tarikh">
                        <div style="font-size:0.85rem; color:var(--text-muted);">Pinjam: <strong>${window.formatDate(item.tPinjam)}</strong></div>
                        <div style="font-size:0.85rem; color:var(--text-muted);">Jangka Pulang: <strong>${window.formatDate(item.tPulang)}</strong></div>
                        <div style="font-weight:500; color:${isLate ? 'var(--danger)' : 'var(--primary)'}; font-size:0.85rem; margin-top:4px; background: ${isLate ? 'var(--danger-light)' : 'var(--primary-light)'}; padding:2px 6px; border-radius:4px; width:max-content;" title="Jumlah hari bahan dipinjam">
                            ‚åõ Tempoh: ${dur} Hari
                        </div>
                    </td>
                    <td data-label="Status">${statusBadge}</td>
                    <td data-label="Tindakan" style="text-align:right;">
                        <button class="btn-3d secondary" onclick="window.prepareEdit('${item.id}')" title="Pinda Maklumat Pinjaman ini">‚úèÔ∏è Pinda Maklumat</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
        window.updateCountUI();
    }

    window.updateCountUI = function() {
        const total = window.dbData.length;
        const active = window.dbData.filter(i => !i.status.includes('Selesai')).length;
        const late = window.dbData.filter(i => !i.status.includes('Selesai') && window.calculateDuration(i.tPinjam, null) > 14).length;
        const ok = active - late;
        
        let fine = 0;
        const m = new Date().getMonth();
        const y = new Date().getFullYear();
        
        window.dbData.forEach(i => { 
            if (i.status.includes('Selesai') && i.tDipulangkan) {
                let d = new Date(i.tDipulangkan);
                if(d.getMonth() === m && d.getFullYear() === y) {
                    if(i.denda) fine += parseFloat(i.denda);
                }
            }
        });

        if(document.getElementById('stat-active')) document.getElementById('stat-active').innerText = active;
        if(document.getElementById('stat-late')) document.getElementById('stat-late').innerText = late;
        if(document.getElementById('statFine')) document.getElementById('statFine').innerText = 'RM ' + fine.toFixed(2);
        if(document.getElementById('stat-total')) document.getElementById('stat-total').innerText = total;

        const notifList = document.getElementById('notificationList');
        if(notifList) {
            notifList.innerHTML = `
                <div class="widget-item" style="border-left: 5px solid var(--text-main);">
                    <span>Buku Belum Pulang <br><b style="font-size:1.1rem; color:var(--text-main); font-weight:600;">${active}</b></span>
                    <span class="widget-search-icon" onclick="window.goToTabFilter('active')" title="Lihat Senarai Belum Pulang">üîç</span>
                </div>
                <div class="widget-item" style="border-left: 5px solid var(--primary); background: var(--primary-light);">
                    <span style="color: var(--primary);">Dalam Tempoh (OK) <br><b style="font-size:1.1rem; font-weight:600;">${ok}</b></span>
                    <span class="widget-search-icon" onclick="window.goToTabFilter('ok')" title="Lihat Senarai Dalam Tempoh" style="background:var(--surface);">üîç</span>
                </div>
                <div class="widget-item" style="border-left: 5px solid var(--danger); background: var(--danger-light);">
                    <span style="color: var(--danger);">Lebih Had 14 Hari <br><b style="font-size:1.1rem; font-weight:600;">${late}</b></span>
                    <span class="widget-search-icon" onclick="window.goToTabFilter('late')" title="Lihat Senarai Lewat" style="background:var(--surface);">üîç</span>
                </div>
            `;
        }
    }

    // --- NEW BOOKS WIDGET ---
    window.updateNewBooksWidget = function() {
        const container = document.getElementById('newBooksWidgetList');
        if(!container) return;

        const now = new Date();
        const m = now.getMonth();
        const y = now.getFullYear();

        const filtered = window.dbBuku.filter(b => {
            const d = new Date(b.tarikh);
            return d.getMonth() === m && d.getFullYear() === y;
        });

        if(filtered.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:15px; font-size:0.85rem; color:var(--text-muted);">Tiada bahan baru didaftarkan bulan ini.</div>';
            return;
        }

        let html = '';
        // Display top 5 recently added (they are already sorted by date desc)
        filtered.slice(0, 5).forEach(b => {
            const bColor = b.kategori === 'Buku Percuma' ? 'var(--success)' : 'var(--warning)';
            html += `
                <div style="background: var(--bg-body); border: 1px solid var(--border); border-left: 3px solid ${bColor}; padding: 8px 10px; border-radius: 6px;">
                    <div style="font-weight: 600; font-size: 0.85rem; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${b.tajuk}">${b.tajuk}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                        <span style="font-size: 0.75rem; color: var(--text-muted);">${window.formatDate(b.tarikh)}</span>
                        <span style="font-size: 0.7rem; font-weight: 600; color: ${bColor}; background: var(--surface); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border);">${b.kategori}</span>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // --- DENDA MODAL ---
    window.openFineModal = function() {
        const tbody = document.getElementById('fineTableBody');
        tbody.innerHTML = '';
        let totalFine = 0;
        let count = 1;

        window.dbData.forEach(item => {
            const dur = window.calculateDuration(item.tPinjam, item.status.includes('Selesai') ? item.tDipulangkan : null);
            const overdue = dur - 14;
            const liveFine = overdue > 0 ? (overdue * 0.20) : 0;
            const savedFine = item.denda ? parseFloat(item.denda) : 0;
            const actualFine = item.status.includes('Selesai') ? savedFine : liveFine;

            if (actualFine > 0) {
                totalFine += actualFine;
                const statusBadge = item.status.includes('Selesai') ? 
                    '<span style="color:var(--success); font-weight:500; font-size:0.85rem; background:#f0fdf4; padding:2px 8px; border-radius:12px; border:1px solid var(--success);" title="Pembayaran denda sudah diselesaikan peminjam">Dibayar</span>' : 
                    '<span style="color:var(--danger); font-weight:500; font-size:0.85rem; background:#fef2f2; padding:2px 8px; border-radius:12px; border:1px solid var(--danger);" title="Buku belum dipulangkan dan denda masih berjalan">Tertunggak</span>';
                    
                tbody.innerHTML += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="text-align:center; padding:10px;">${count++}</td>
                        <td style="padding:10px;"><strong style="font-size:0.95rem; color:var(--text-main);">${item.nama}</strong><br><small style="color:var(--text-muted);">${item.noPekerja}</small></td>
                        <td style="padding:10px;">${item.tajuk}</td>
                        <td style="text-align:center; padding:10px; color:var(--danger); font-weight:500; font-size:0.95rem;">${overdue} Hari</td>
                        <td style="text-align:right; padding:10px; font-weight:500; font-size:0.95rem;">RM ${actualFine.toFixed(2)}</td>
                        <td style="text-align:center; padding:10px;">${statusBadge}</td>
                    </tr>
                `;
            }
        });

        if (count === 1) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; font-weight:400; color:var(--text-muted);">Tiada rekod denda buat masa ini.</td></tr>';
        }

        document.getElementById('totalFineAmount').innerText = 'RM ' + totalFine.toFixed(2);
        document.getElementById('fineModal').style.display = 'flex';
        document.getElementById('fineModal').classList.add('open');
    }

    window.closeFineModal = function() {
        document.getElementById('fineModal').classList.remove('open');
        setTimeout(() => { document.getElementById('fineModal').style.display = 'none'; }, 200);
    }

    // --- CALENDAR (ISN START) ---
    window.changeMonth = function(n) { calDateGlobal.setMonth(calDateGlobal.getMonth() + n); window.renderCalendar(); }

    window.renderCalendar = function() {
        const m = calDateGlobal.getMonth(), y = calDateGlobal.getFullYear();
        if(!document.getElementById('calMonthYear')) return;
        
        document.getElementById('calMonthYear').innerText = new Date(y, m).toLocaleDateString('ms-MY', { month: 'long', year: 'numeric' });
        
        const firstDayIndex = new Date(y, m, 1).getDay(); 
        const adjustedFirstDay = (firstDayIndex === 0) ? 6 : firstDayIndex - 1; // Isnin Start
        const daysInMonth = new Date(y, m + 1, 0).getDate();
        const grid = document.getElementById('calGrid');
        grid.innerHTML = '';

        for (let i = 0; i < adjustedFirstDay; i++) grid.innerHTML += `<div></div>`;

        for (let i = 1; i <= daysInMonth; i++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            
            let borrowCount = 0;
            let dueCount = 0;

            window.dbData.forEach(item => {
                if (item.tPinjam === dateStr) borrowCount++;
                if (item.tPulang === dateStr && !item.status.includes('Selesai')) dueCount++;
            });

            let content = `<span style="font-weight:600; font-size:1.1rem; margin-bottom:2px;">${i}</span>`;
            if (borrowCount > 0) content += `<div class="cal-info" style="color:var(--success);" title="${borrowCount} bahan mulai dipinjam pada hari ini">+${borrowCount} Pinjam</div>`;
            if (dueCount > 0) content += `<div class="cal-info" style="color:var(--danger);" title="${dueCount} bahan perlu dipulangkan semula hari ini">${dueCount} Pulang</div>`;

            const currentGridIndex = adjustedFirstDay + i - 1;
            const colIndex = currentGridIndex % 7; 
            const isWeekend = (colIndex === 5 || colIndex === 6);
            const weekendClass = isWeekend ? 'weekend' : '';

            const isToday = (new Date().toDateString() === new Date(y, m, i).toDateString()) ? 'today' : '';
            grid.innerHTML += `<div class="cal-day ${isToday} ${weekendClass}" onclick="window.clickCal(${i})" title="Pergi ke ${i} haribulan di Senarai Pinjaman">${content}</div>`;
        }
    }

    window.clickCal = function(day) {
        let m = String(calDateGlobal.getMonth() + 1).padStart(2, '0');
        let d = String(day).padStart(2, '0');
        let dateStr = `${calDateGlobal.getFullYear()}-${m}-${d}`;
        window.switchTab('senarai');
        const searchInput = document.getElementById('searchInput');
        if(searchInput) searchInput.value = dateStr;
        window.setFilter('all');
        window.renderTable();
    }

    // --- MODAL PINJAMAN UTAMA ---
    window.openModal = function() {
        currId = null;
        document.getElementById('docId').value = '';
        const inputs = document.querySelectorAll('#statusModal .form-input');
        inputs.forEach(i => {
            if(i.type !== 'radio' && i.type !== 'checkbox' && i.type !== 'button') i.value = '';
        });
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('em_tPinjam').value = today;
        window.autoCalcReturnDateEdit();
        
        const radioDipinjam = document.getElementById('radio_belum');
        if(radioDipinjam) radioDipinjam.checked = true;

        window.toggleReturnDateInput();
        if(document.getElementById('waLinkBtn')) document.getElementById('waLinkBtn').style.display = 'none';
        if(document.getElementById('btnDelete')) document.getElementById('btnDelete').style.display = 'none';
        document.getElementById('sm_title').innerText = "üìù Rekod Pinjaman Baru";
        
        document.getElementById('statusModal').style.display = 'flex';
        setTimeout(() => document.getElementById('statusModal').classList.add('open'), 10);
        window.recalcModalCalc();
    }

    window.closeStatusModal = function() { 
        document.getElementById('statusModal').classList.remove('open');
        setTimeout(() => { document.getElementById('statusModal').style.display = 'none'; }, 200);
    }
    
    // Fallback for previous function name
    window.closeModal = window.closeStatusModal;

    window.prepareEdit = function(id) {
        currId = String(id);
        const item = window.dbData.find(x => String(x.id) === currId);
        if(!item) return;

        document.getElementById('sm_title').innerText = "‚úèÔ∏è Pinda Maklumat Pinjaman";
        document.getElementById('docId').value = id;
        document.getElementById('em_nama').value = item.nama;
        document.getElementById('em_noPekerja').value = item.noPekerja;
        document.getElementById('em_whatsapp').value = item.whatsapp || '';
        document.getElementById('em_bahagian').value = item.bahagian || '';
        document.getElementById('em_jenis').value = item.jenis;
        document.getElementById('em_tajuk').value = item.tajuk;
        document.getElementById('em_tPinjam').value = item.tPinjam;
        document.getElementById('sm_tPulang').value = item.tPulang; 
        document.getElementById('em_catatan').value = item.catatan || ''; 
        
        const isSelesai = item.status.includes('Selesai');
        if(isSelesai) {
            document.getElementById('radio_sudah').checked = true;
            document.getElementById('em_tDipulangkan').value = item.tDipulangkan || new Date().toISOString().split('T')[0];
        } else {
            document.getElementById('radio_belum').checked = true;
            document.getElementById('em_tDipulangkan').value = new Date().toISOString().split('T')[0];
        }

        window.toggleReturnDateInput();
        
        // WhatsApp Button
        const btnWA = document.getElementById('waLinkBtn');
        if(item.whatsapp && btnWA) {
            btnWA.style.display = 'inline-flex';
            btnWA.href = `https://wa.me/${item.whatsapp.replace(/[^0-9]/g, '')}`;
        } else if (btnWA) {
            btnWA.style.display = 'none';
        }

        if(document.getElementById('btnDelete')) document.getElementById('btnDelete').style.display = 'inline-flex';

        document.getElementById('statusModal').style.display = 'flex';
        setTimeout(() => document.getElementById('statusModal').classList.add('open'), 10);
        window.recalcModalCalc();
    }

    window.toggleReturnDateInput = function() {
        const isPulang = document.getElementById('radio_sudah').checked;
        const div = document.getElementById('div_actual_return_date');
        const ph = document.getElementById('div_actual_return_placeholder');
        if(div) {
            div.style.display = isPulang ? 'block' : 'none';
            if(ph) ph.style.display = isPulang ? 'none' : 'block';
        }
        window.recalcModalCalc();
    }

    window.recalcModalCalc = function() {
        const startVal = document.getElementById('em_tPinjam').value;
        const isPulangRadio = document.getElementById('radio_sudah');
        const isPulang = isPulangRadio ? isPulangRadio.checked : false;
        if(!startVal) return;

        let endDateStr = isPulang ? document.getElementById('em_tDipulangkan').value : null;
        const duration = window.calculateDuration(startVal, endDateStr);
        const limit = 14;
        const overdue = duration - limit;
        const denda = overdue > 0 ? (overdue * DENDA_PER_HARI).toFixed(2) : 0.00;

        const durInfo = document.getElementById('sm_duration_info');
        if(durInfo) durInfo.innerHTML = `‚è≥ Tempoh: <strong>${duration} Hari</strong>`;
        
        const infoDiv = document.getElementById('sm_info_container');
        if(infoDiv) {
            if(overdue > 0) {
                infoDiv.innerHTML = `<span style="font-size:0.85rem">‚ö†Ô∏è Lebih ${overdue} hari (Denda: RM ${denda})</span>`;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }
    }

    // --- TAB BUKU BARU LOGIC ---
    window.renderBukuTable = function() {
        const tbody = document.getElementById('bukuTableBody');
        if(!tbody) return;
        const search = document.getElementById('searchBukuInput').value.toLowerCase();
        tbody.innerHTML = '';

        // Pastikan sentiasa diisih (sort) mengikut tarikh penerimaan terbaru (descending)
        window.dbBuku.sort((a,b) => new Date(b.tarikh) - new Date(a.tarikh));

        const dataToRender = window.dbBuku.filter(item => {
            const txt = (item.tajuk + (item.isbn||'') + item.penerbitan + item.kategori + item.sumber + item.bidang).toLowerCase();
            return !search || txt.includes(search);
        });

        // Kemaskini widget buku baru di dashboard
        window.updateNewBooksWidget();

        if(dataToRender.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:var(--text-muted);">Tiada rekod buku dijumpai.</td></tr>';
            return;
        }

        dataToRender.forEach(item => {
            const badgeColor = item.kategori === 'Buku Percuma' ? 'var(--success)' : '#F59E0B';
            const badgeBg = item.kategori === 'Buku Percuma' ? '#E8F5E9' : '#FFFBEB';
            
            // Warna latar (background) jadual membezakan Bidang Perusahaan Kayu atau Bukan
            const rowBgStyle = item.bidang === 'Perusahaan Kayu' ? 'background: var(--bg-kayu);' : 'background: var(--bg-bukan-kayu);';
            const kivBadge = item.status_rekod === 'KIV' ? `<span style="background:var(--danger-light); color:var(--danger); padding:2px 6px; border-radius:4px; font-size:0.75rem; font-weight:600; margin-left:8px;" title="Rekod Sementara (KIV)">‚è≥ KIV</span>` : '';

            tbody.innerHTML += `
                <tr style="${rowBgStyle}">
                    <td data-label="Tarikh"><strong>${window.formatDate(item.tarikh)}</strong></td>
                    <td data-label="Tajuk"><div style="font-weight:500; font-size:1.05rem;">${item.tajuk} ${kivBadge}</div><div style="color:var(--text-muted); font-size:0.85rem;">Edisi: ${item.edisi || '-'} | Bil: ${item.bilangan}</div></td>
                    <td data-label="Info Bahan"><div style="font-size:0.85rem;">${item.jenis} - <span style="font-weight:500;">${item.bidang}</span></div><div style="color:var(--primary); font-size:0.85rem; font-family:monospace; font-weight:500;">${item.isbn || '-'}</div></td>
                    <td data-label="Penerima / Sumber"><div style="font-size:0.9rem; font-weight:500;">${item.penerima}</div><div style="font-size:0.8rem; color:var(--text-muted);">Sumber: ${item.sumber}</div><div style="font-size:0.8rem; color:var(--text-muted);">Terbitan: ${item.penerbitan}</div></td>
                    <td data-label="Kategori"><span style="color:${badgeColor}; background:${badgeBg}; padding:4px 8px; border-radius:4px; font-weight:500; font-size:0.8rem; display:inline-block;">${item.kategori}</span></td>
                    <td data-label="Tindakan" style="text-align:right;">
                        <button class="btn-3d secondary" onclick="window.prepareEditBuku('${item.id}')" title="Kemaskini maklumat bahan rujukan ini">‚úèÔ∏è Pinda Maklumat</button>
                    </td>
                </tr>
            `;
        });
    }

    window.openBukuModal = function() {
        document.getElementById('bukuId').value = '';
        document.querySelectorAll('#bukuModal .form-input').forEach(i => { if(i.id !== 'b_bilangan') i.value = ''; });
        document.getElementById('b_bilangan').value = '1';
        document.getElementById('b_tarikh').valueAsDate = new Date();
        document.getElementById('b_kategori').value = 'Buku Percuma';
        document.getElementById('b_jenis').value = 'Buku';
        document.getElementById('b_bidang').value = 'Perusahaan Kayu';
        document.getElementById('b_penerbitan').value = 'Dalam Negara';
        
        if(document.getElementById('btnDeleteBuku')) document.getElementById('btnDeleteBuku').style.display = 'none';
        document.getElementById('bukuModal').style.display = 'flex';
        setTimeout(() => document.getElementById('bukuModal').classList.add('open'), 10);
    }

    window.closeBukuModal = function() { 
        document.getElementById('bukuModal').classList.remove('open'); 
        setTimeout(() => document.getElementById('bukuModal').style.display = 'none', 200);
    }

    window.prepareEditBuku = function(id) {
        const item = window.dbBuku.find(x => String(x.id) === String(id));
        if(!item) return;

        document.getElementById('bukuId').value = id;
        document.getElementById('b_kategori').value = item.kategori || 'Buku Percuma';
        document.getElementById('b_tarikh').value = item.tarikh;
        document.getElementById('b_tajuk').value = item.tajuk;
        document.getElementById('b_edisi').value = item.edisi || '';
        document.getElementById('b_bilangan').value = item.bilangan || 1;
        document.getElementById('b_isbn').value = item.isbn || '';
        document.getElementById('b_jenis').value = item.jenis || 'Buku';
        document.getElementById('b_bidang').value = item.bidang || 'Perusahaan Kayu';
        document.getElementById('b_penerbitan').value = item.penerbitan || 'Dalam Negara';
        document.getElementById('b_penerima').value = item.penerima || '';
        document.getElementById('b_sumber').value = item.sumber || '';
        
        if(document.getElementById('btnDeleteBuku')) document.getElementById('btnDeleteBuku').style.display = 'inline-flex';
        document.getElementById('bukuModal').style.display = 'flex';
        setTimeout(() => document.getElementById('bukuModal').classList.add('open'), 10);
    }

    // --- PRINT REPORTS ---
    window.printMonthlyReport = function() {
        const m = parseInt(document.getElementById('reportMonth').value);
        const y = parseInt(document.getElementById('reportYear').value);
        const today = new Date().toLocaleDateString('ms-MY');

        const filtered = window.dbData.filter(item => {
            const d = new Date(item.tPinjam);
            return d.getMonth() === m && d.getFullYear() === y;
        });

        if(filtered.length === 0) return alert("Tiada rekod untuk bulan ini.");

        const monthNames = ["Januari", "Februari", "Mac", "April", "Mei", "Jun", "Julai", "Ogos", "September", "Oktober", "November", "Disember"];
        
        let html = `<html><head>
            <title>Laporan Pinjaman - ${monthNames[m]} ${y}</title>
            <style>
                @page { size: landscape; margin: 20mm; }
                body { font-family: sans-serif; padding: 20px; font-size:12px;}
                h2 { text-align: center; margin-bottom: 5px; text-transform: uppercase;}
                p { text-align: center; color: #555; margin-top: 0; font-weight: bold;}
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #000; padding: 8px; text-align: left; font-size: 11px; }
                th { background-color: #f2f2f2; text-transform: uppercase; font-weight: bold;}
                .date-print { position: absolute; top: 0px; right: 0px; font-size: 10px; color: #999; }
            </style>
        </head><body>
            <div class="date-print">Tarikh Cetakan: ${today}</div>
            <h2>LAPORAN PINJAMAN PUSTAKA</h2>
            <p>Bulan: ${monthNames[m]} ${y}</p>
            <table><thead><tr>
                <th width="3%" style="text-align:center;">No</th>
                <th width="20%">Nama Peminjam / Bahagian</th>
                <th width="20%">Bahan/Tajuk</th>
                <th width="10%" style="text-align:center;">Tarikh Pinjam</th>
                <th width="10%" style="text-align:center;">Jangka Pulang</th>
                <th width="10%" style="text-align:center;">Tarikh Pulang (Sebenar)</th>
                <th width="7%" style="text-align:center;">Hari Lewat</th>
                <th width="10%" style="text-align:right;">Caj Denda</th>
                <th width="10%" style="text-align:center;">Status</th>
            </tr></thead><tbody>`;

        filtered.forEach((item, idx) => {
            const dur = window.calculateDuration(item.tPinjam, item.tDipulangkan || null);
            const lateDays = dur - 14 > 0 ? dur - 14 : 0;
            const actualReturn = item.tDipulangkan ? window.formatDate(item.tDipulangkan) : '-';
            const fine = item.denda || '0.00';
            const bhgStr = item.bahagian ? `<br><span style="color:#1A73E8; font-weight:bold;">[${item.bahagian}]</span>` : '';

            html += `<tr>
                <td style="text-align:center; font-weight:bold;">${idx + 1}</td>
                <td><strong>${item.nama}</strong><br><span style="color:#666; font-weight:bold;">${item.noPekerja}</span>${bhgStr}</td>
                <td><strong>${item.tajuk}</strong><br><span style="background:#eee; padding:2px 4px; border-radius:3px; font-size:9px; font-weight:bold;">${item.jenis}</span></td>
                <td style="text-align:center; font-weight:bold;">${window.formatDate(item.tPinjam)}</td>
                <td style="text-align:center; font-weight:bold;">${window.formatDate(item.tPulang)}</td>
                <td style="text-align:center; font-weight:bold;">${actualReturn}</td>
                <td style="text-align:center; font-weight:bold; color:${lateDays>0?'#D93025':'#333'}">${lateDays > 0 ? lateDays : '-'}</td>
                <td style="text-align:right; font-weight:bold;">${fine > 0 ? 'RM '+parseFloat(fine).toFixed(2) : '-'}</td>
                <td style="text-align:center; font-weight:bold; color:${item.status.includes('Selesai')?'#1E8E3E':'#D93025'}">${item.status.includes('Selesai') ? 'Selesai' : 'Belum Pulang'}</td>
            </tr>`;
        });
        html += `</tbody></table>
            <div class="footer" style="margin-top: 40px; text-align: center; font-size: 10px; font-style: italic; color: #999; border-top: 1px dashed #ddd; padding-top: 10px;">
                Dokumen ini dicetak melalui Sistem Pustakawan Digital dan tidak memerlukan tandatangan.
            </div>
        </body></html>`;

        const win = window.open('', '', 'width=1100,height=600');
        win.document.write(html);
        win.document.close();
        win.print();
    }

    window.printFineReport = function() {
        const today = new Date().toLocaleDateString('ms-MY');
        let html = `<html><head>
            <title>Laporan Kutipan Denda</title>
            <style>
                body { font-family: 'Segoe UI', Arial, sans-serif; padding:20px; font-size:12px; color: #333; } 
                table { width:100%; border-collapse:collapse; margin-top:20px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
                th,td { border:1px solid #ddd; padding:10px; font-size:12px; text-align:left; } 
                th { background:#f4f4f4; text-transform: uppercase; font-weight: bold; }
                .text-center { text-align:center; } .text-right { text-align:right; }
                h2 { text-align:center; margin:5px 0; font-size: 18px; letter-spacing: 1px; }
                p { text-align:center; margin:0 0 20px 0; color: #666; }
                .footer { margin-top: 40px; text-align: center; font-size: 10px; font-style: italic; color: #999; border-top: 1px dashed #ddd; padding-top: 10px; }
            </style>
        </head><body>
            <h2>LAPORAN KUTIPAN DENDA PUSTAKA</h2>
            <p>Tarikh Cetakan: <strong>${today}</strong></p>
            <table><thead><tr>
                <th width="5%" class="text-center">No</th>
                <th width="25%">Maklumat Peminjam</th>
                <th width="30%">Tajuk Bahan Pinjaman</th>
                <th width="10%" class="text-center">Bil. Hari Lewat</th>
                <th width="15%" class="text-right">Kadar Denda (RM)</th>
                <th width="15%" class="text-center">Status Bayaran</th>
            </tr></thead><tbody>`;

        let totalFine = 0;
        let count = 1;

        window.dbData.forEach(item => {
            const dur = window.calculateDuration(item.tPinjam, item.status.includes('Selesai') ? item.tDipulangkan : null);
            const overdue = dur - 14;
            const liveFine = overdue > 0 ? (overdue * 0.20) : 0;
            const savedFine = item.denda ? parseFloat(item.denda) : 0;
            const actualFine = item.status.includes('Selesai') ? savedFine : liveFine;

            if (actualFine > 0) {
                totalFine += actualFine;
                const statusTxt = item.status.includes('Selesai') ? '<span style="color:#1E8E3E">Dibayar</span>' : '<span style="color:#D93025">Tertunggak</span>';
                html += `<tr>
                    <td class="text-center">${count++}</td>
                    <td><strong>${item.nama}</strong><br><span style="color:#666">${item.noPekerja}</span></td>
                    <td>${item.tajuk}</td>
                    <td class="text-center" style="color:#D93025; font-weight:bold;">${overdue}</td>
                    <td class="text-right" style="font-weight:bold;">${parseFloat(actualFine).toFixed(2)}</td>
                    <td class="text-center" style="font-weight:bold;">${statusTxt}</td>
                </tr>`;
            }
        });

        if (count === 1) html += `<tr><td colspan="6" class="text-center" style="padding:20px; color:#999;">Tiada rekod denda direkodkan setakat ini.</td></tr>`;

        html += `<tr>
            <td colspan="4" class="text-right" style="font-size:14px;"><strong>JUMLAH KESELURUHAN DENDA:</strong></td>
            <td class="text-right" style="font-size:14px; color:#D93025;"><strong>RM ${totalFine.toFixed(2)}</strong></td>
            <td></td>
        </tr></tbody></table>
        <div class="footer">Dokumen ini dijana secara automatik oleh Sistem Pustakawan Digital.</div>
        </body></html>`;

        const win = window.open('', '', 'width=900,height=600');
        win.document.write(html);
        win.document.close();
        win.print();
    }

    window.printBukuReport = function() {
        const y = parseInt(document.getElementById('printBukuYear').value);
        const today = new Date().toLocaleDateString('ms-MY');

        const filtered = window.dbBuku.filter(item => new Date(item.tarikh).getFullYear() === y);

        if(filtered.length === 0) return alert("Tiada rekod buku baru untuk tahun tersebut.");

        let html = `<html><head>
            <title>Laporan Bahan Rujukan Baharu ${y}</title>
            <style>
                @page { size: landscape; margin: 15mm; }
                body { font-family: Arial, sans-serif; padding:0; font-size:11px; color: #000; } 
                table { width:100%; border-collapse:collapse; margin-top:20px; }
                th,td { border:1px solid #000; padding:6px; font-size:10px; } 
                th { background:#f0f0f0; text-transform: uppercase; font-weight: bold; text-align:center;}
                h2 { text-align:center; margin:5px 0; font-size: 16px; font-weight:bold; }
                .date-print { position: absolute; top: 0px; right: 0px; font-size: 9px; }
            </style>
        </head><body>
            <div class="date-print">Tarikh Cetakan: ${today}</div>
            <h2>BAHAN RUJUKAN BAHARU TAHUN ${y}</h2>
            <table><thead><tr>
                <th width="3%">BIL</th>
                <th width="8%">TARIKH</th>
                <th width="20%">TAJUK</th>
                <th width="10%">EDISI/ISU</th>
                <th width="5%">BILANGAN</th>
                <th width="10%">ISSN/ISBN</th>
                <th width="8%">JENIS BAHAN</th>
                <th width="10%">BIDANG</th>
                <th width="8%">PENERBITAN</th>
                <th width="8%">PENERIMA</th>
                <th width="10%">PEROLEHAN DARIPADA</th>
            </tr></thead><tbody>`;

        filtered.forEach((item, idx) => {
            html += `<tr>
                <td style="text-align:center">${idx + 1}</td>
                <td style="text-align:center">${window.formatDate(item.tarikh)}</td>
                <td><strong>${item.tajuk}</strong><br><small style="color:#1A73E8; font-weight:bold;">[${item.kategori}]</small></td>
                <td>${item.edisi || '-'}</td>
                <td style="text-align:center">${item.bilangan || 1}</td>
                <td style="text-align:center">${item.isbn || '-'}</td>
                <td style="text-align:center">${item.jenis || '-'}</td>
                <td style="text-align:center">${item.bidang || '-'}</td>
                <td style="text-align:center">${item.penerbitan || '-'}</td>
                <td style="text-align:center">${item.penerima || '-'}</td>
                <td style="text-align:center">${item.sumber || '-'}</td>
            </tr>`;
        });
        html += `</tbody></table></body></html>`;

        const win = window.open('', '', 'width=1100,height=600');
        win.document.write(html);
        win.document.close();
        win.print();
    }

    // --- EXPORT DATABASE ---
    window.exportDatabase = function() {
        if(window.dbData && window.dbData.length === 0) return alert("Tiada data pinjaman untuk dieksport.");
        let c = "Nama,ID,Bahagian,Bahan,Tajuk,Tempoh(Hari),Pinjam,Jangka_Pulang,Status,Denda,Catatan\n";
        window.dbData.forEach(x => {
            let dur = window.calculateDuration(x.tPinjam, x.status.includes('Selesai') ? x.tDipulangkan : null);
            let note = x.catatan ? x.catatan.replace(/,/g, ' ') : '';
            c += `"${x.nama}","${x.noPekerja}","${x.bahagian || ''}","${x.jenis}","${x.tajuk}","${dur}","${x.tPinjam}","${x.tPulang}","${x.status}","${x.denda || 0}","${note}"\n`
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([c],{type:'text/csv'}));
        a.download = 'Backup_Pinjaman_DB.csv'; a.click();
    };

    window.exportBukuDatabase = function() {
        if(window.dbBuku && window.dbBuku.length === 0) return alert("Tiada data buku untuk dieksport.");
        let c = "Kategori,Tarikh,Tajuk,Edisi,Bilangan,ISBN,Jenis,Bidang,Penerbitan,Penerima,Sumber,Status\n";
        window.dbBuku.forEach(x => {
            c += `"${x.kategori}","${x.tarikh}","${x.tajuk}","${x.edisi||''}","${x.bilangan||1}","${x.isbn||''}","${x.jenis||''}","${x.bidang||''}","${x.penerbitan||''}","${x.penerima||''}","${x.sumber||''}","${x.status_rekod||'Aktif'}"\n`;
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([c],{type:'text/csv'}));
        a.download = 'Backup_Buku_DB.csv'; a.click();
    };
</script>

<!-- FIREBASE SCRIPT (CLOUD DATA) -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAfEJBFMTX1HOo5SMpfDf4Cx61HhbtiAWE",
      authDomain: "pustakawan-digital.firebaseapp.com",
      projectId: "pustakawan-digital",
      storageBucket: "pustakawan-digital.firebasestorage.app",
      messagingSenderId: "811520945210",
      appId: "1:811520945210:web:667f2d12138c7db4dc1903"
    };

    let dbInstance;

    window.initFirebase = function() {
        try {
            const app = initializeApp(firebaseConfig);
            dbInstance = getFirestore(app);
            const status = document.getElementById('statusText');
            if(status) {
                status.innerHTML = "üåê Dalam Talian";
                status.style.color = "var(--success)";
            }
            startListening();
        } catch (e) {
            const status = document.getElementById('statusText');
            if(status) {
                status.innerHTML = "üî¥ Tiada Sambungan";
                status.style.color = "var(--danger)";
            }
            console.error("Ralat Firebase: " + e.message);
        }
    }

    function startListening() {
        // Listener untuk Pinjaman
        onSnapshot(collection(dbInstance, "pinjaman"), (snapshot) => {
            window.dbData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            window.dbData.sort((a,b) => new Date(b.tPinjam) - new Date(a.tPinjam));
            window.renderTable();
            window.renderCalendar(); 
        }, (error) => {
            console.error("Gagal baca data pinjaman:", error);
            const status = document.getElementById('statusText');
            if(status) {
                status.innerHTML = "üî¥ Tiada Sambungan";
                status.style.color = "var(--danger)";
            }
        });

        // Listener untuk Buku Baru
        onSnapshot(collection(dbInstance, "buku_baru"), (snapshot) => {
            window.dbBuku = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            window.dbBuku.sort((a,b) => new Date(b.tarikh) - new Date(a.tarikh));
            window.renderBukuTable();
        }, (error) => {
            console.error("Gagal baca data buku:", error);
        });
    }

    // --- SAVE & DELETE PINJAMAN (CLOUD) ---
    window.saveData = async function() {
        if(!dbInstance) return alert("Tiada sambungan pangkalan data.");
        
        const docId = document.getElementById('docId').value;
        const statusEl = document.querySelector('input[name="sm_status_pulang"]:checked');
        const isSelesai = statusEl ? statusEl.value === 'sudah' : false;

        const tPinjam = document.getElementById('em_tPinjam').value || document.getElementById('f_tPinjam').value;
        const tDipulangkan = document.getElementById('em_tDipulangkan').value || document.getElementById('f_tDipulangkan').value;
        const tPulang = document.getElementById('sm_tPulang').value || document.getElementById('f_tPulang').value;
        
        let endDate = (isSelesai && tDipulangkan) ? new Date(tDipulangkan) : new Date();
        endDate.setHours(0,0,0,0);
        const startDate = new Date(tPinjam);
        startDate.setHours(0,0,0,0);
        const days = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24));
        const overdue = days - 14;
        const dendaVal = overdue > 0 ? (overdue * 0.20).toFixed(2) : "0.00";

        const data = {
            nama: document.getElementById('em_nama').value || document.getElementById('f_nama').value,
            noPekerja: document.getElementById('em_noPekerja').value || document.getElementById('f_noPekerja').value,
            whatsapp: document.getElementById('em_whatsapp').value || document.getElementById('f_phone').value, 
            bahagian: document.getElementById('em_bahagian').value || document.getElementById('f_bahagian').value,
            jenis: document.getElementById('em_jenis').value || document.getElementById('f_jenis').value,
            tajuk: document.getElementById('em_tajuk').value || document.getElementById('f_tajuk').value,
            tPinjam: tPinjam,
            tPulang: tPulang, 
            tDipulangkan: isSelesai ? tDipulangkan : null, 
            status: isSelesai ? 'Selesai' : 'Dipinjam',
            denda: dendaVal,
            catatan: document.getElementById('em_catatan').value || document.getElementById('f_catatan').value
        };

        if(!data.nama || !data.tajuk) return alert("Sila isi Nama Peminjam dan Tajuk Bahan.");

        document.getElementById('loadingBar').style.display = 'block';
        try {
            if (docId) {
                await updateDoc(doc(dbInstance, "pinjaman", docId), data);
            } else {
                await addDoc(collection(dbInstance, "pinjaman"), data);
            }
            // Pastikan isihan tempatan juga dilakukan sementara tunggu listener siap
            window.dbData.sort((a,b) => new Date(b.tPinjam) - new Date(a.tPinjam));
            window.closeModal();
            window.closeStatusModal();
        } catch (e) {
            alert("GAGAL SIMPAN: " + e.message);
            const status = document.getElementById('statusText');
            if(status) {
                status.innerHTML = "üî¥ Tiada Sambungan";
                status.style.color = "var(--danger)";
            }
        }
        document.getElementById('loadingBar').style.display = 'none';
    }

    window.deleteRecord = async function() {
        const docId = document.getElementById('docId').value;
        if (!docId) return alert("Sila pilih rekod.");
        if(confirm("Padam rekod pinjaman ini secara kekal dari awan?")) {
            document.getElementById('loadingBar').style.display = 'block';
            try {
                await deleteDoc(doc(dbInstance, "pinjaman", docId));
                window.closeModal();
                window.closeStatusModal();
            } catch (e) { alert("Gagal Padam: " + e.message); }
            document.getElementById('loadingBar').style.display = 'none';
        }
    }

    // --- SAVE & DELETE BUKU BARU (CLOUD) ---
    window.saveBuku = async function(statusRec = 'Aktif') {
        if(!dbInstance) return alert("Tiada sambungan pangkalan data.");
        
        const docId = document.getElementById('bukuId').value;
        const data = {
            kategori: document.getElementById('b_kategori').value,
            tarikh: document.getElementById('b_tarikh').value,
            tajuk: document.getElementById('b_tajuk').value,
            edisi: document.getElementById('b_edisi').value,
            bilangan: document.getElementById('b_bilangan').value,
            isbn: document.getElementById('b_isbn').value,
            jenis: document.getElementById('b_jenis').value,
            bidang: document.getElementById('b_bidang').value,
            penerbitan: document.getElementById('b_penerbitan').value,
            penerima: document.getElementById('b_penerima').value,
            sumber: document.getElementById('b_sumber').value,
            status_rekod: statusRec
        };

        if(!data.tajuk) return alert("Sila isi Tajuk Bahan.");

        document.getElementById('loadingBar').style.display = 'block';
        try {
            if (docId) await updateDoc(doc(dbInstance, "buku_baru", docId), data);
            else await addDoc(collection(dbInstance, "buku_baru"), data);
            // Isihan sementara untuk UX lancar
            window.dbBuku.sort((a,b) => new Date(b.tarikh) - new Date(a.tarikh));
            window.closeBukuModal();
        } catch (e) { alert("GAGAL SIMPAN BUKU: " + e.message); }
        document.getElementById('loadingBar').style.display = 'none';
    }

    window.deleteBuku = async function() {
        const docId = document.getElementById('bukuId').value;
        if (!docId) return alert("Sila pilih rekod.");
        if(confirm("Padam rekod buku ini secara kekal dari awan?")) {
            document.getElementById('loadingBar').style.display = 'block';
            try {
                await deleteDoc(doc(dbInstance, "buku_baru", docId));
                window.closeBukuModal();
            } catch (e) { alert("Gagal Padam: " + e.message); }
            document.getElementById('loadingBar').style.display = 'none';
        }
    }
</script>
</body>
</html>
